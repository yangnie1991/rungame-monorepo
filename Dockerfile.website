# RunGame Website - ä¼˜åŒ–çš„å¤šé˜¶æ®µ Docker æ„å»º
# åŸºäº Next.js å®˜æ–¹æœ€ä½³å®è·µ + Monorepo æ¶æ„

# ============================================
# ç¬¬ä¸€é˜¶æ®µ: åŸºç¡€é•œåƒ
# ============================================
FROM node:20-alpine AS base
WORKDIR /app

# ============================================
# ç¬¬äºŒé˜¶æ®µ: ä¾èµ–å®‰è£…
# ============================================
FROM base AS deps

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–ï¼ˆä»… libc6-compatï¼‰
RUN apk add --no-cache libc6-compat

# å¤åˆ¶ package æ–‡ä»¶
COPY package*.json ./
COPY apps/website/package*.json ./apps/website/
COPY packages/database/package*.json ./packages/database/

# å®‰è£…ä¾èµ–
RUN npm ci

# ============================================
# ç¬¬ä¸‰é˜¶æ®µ: æ„å»ºåº”ç”¨
# ============================================
FROM base AS builder

# å¤åˆ¶ä¾èµ–
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/apps/website/node_modules ./apps/website/node_modules
COPY --from=deps /app/packages/database/node_modules ./packages/database/node_modules

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºå‚æ•°
ARG DATABASE_URL
ARG NODE_ENV=production
# è®¾ç½® Docker æ„å»ºæ ‡å¿—
ENV DOCKER_BUILD=true

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DATABASE_URL=${DATABASE_URL}
ENV NODE_ENV=${NODE_ENV}
ENV NEXT_TELEMETRY_DISABLED=1

# ç”Ÿæˆ Prisma Client
RUN npm run db:generate

# æ„å»º website åº”ç”¨ï¼ˆä½¿ç”¨ Turbopackï¼Œç”Ÿæˆ standalone è¾“å‡ºï¼‰
RUN npm run build:website

# ============================================
# ç¬¬å››é˜¶æ®µ: ç”Ÿäº§è¿è¡Œæ—¶ï¼ˆStandalone ä¼˜åŒ–ï¼‰
# ============================================
FROM base AS runner

# åˆ›å»ºé root ç”¨æˆ·
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–ï¼ˆä»… curl ç”¨äºå¥åº·æ£€æŸ¥ï¼‰
RUN apk add --no-cache curl

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# ğŸ”¥ å…³é”®ä¼˜åŒ–ï¼šå¤åˆ¶ standalone è¾“å‡º
COPY --from=builder --chown=nextjs:nodejs /app/apps/website/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/website/.next/static ./apps/website/.next/static
COPY --from=builder --chown=nextjs:nodejs /app/apps/website/public ./apps/website/public

# Monorepo ç‰¹æ®Šéœ€æ±‚ï¼šå¤åˆ¶æ•°æ®åº“åŒ…
COPY --from=builder --chown=nextjs:nodejs /app/packages/database ./packages/database

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nextjs

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥ï¼ˆæ£€æŸ¥é¦–é¡µï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:3000/ || exit 1

# ğŸ”¥ ä½¿ç”¨ standalone ç”Ÿæˆçš„ server.js
CMD ["node", "apps/website/server.js"]
