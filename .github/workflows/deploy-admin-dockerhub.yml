name: Deploy Admin to Docker Hub & VPS

on:
  push:
    branches: [ "main" ]
    paths:
      # ä»…å½“ä»¥ä¸‹æ–‡ä»¶å˜åŠ¨æ—¶è§¦å‘ï¼Œé¿å…ä¿®æ”¹æ–‡æ¡£ä¹Ÿè§¦å‘æž„å»º
      - 'apps/admin/**'
      - 'packages/**'
      - 'Dockerfile.admin'
      - 'docker-compose.admin.yml'
      - '.github/workflows/deploy-admin-dockerhub.yml'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹æŒ‰é’®è§¦å‘

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Debug Secrets Presence
        run: |
          echo "Checking secret presence..."
          if [ -n "${{ secrets.BETTER_AUTH_URL }}" ]; then echo "BETTER_AUTH_URL is SET"; else echo "BETTER_AUTH_URL is NOT SET"; fi
          if [ -n "${{ secrets.DATABASE_URL }}" ]; then echo "DATABASE_URL is SET"; else echo "DATABASE_URL is NOT SET"; fi
          if [ -n "${{ secrets.BETTER_AUTH_SECRET }}" ]; then echo "BETTER_AUTH_SECRET is SET"; else echo "BETTER_AUTH_SECRET is NOT SET"; fi
          if [ -n "${{ secrets.ENCRYPTION_KEY }}" ]; then echo "ENCRYPTION_KEY is SET"; else echo "ENCRYPTION_KEY is NOT SET"; fi
          if [ -n "${{ secrets.NEXT_PUBLIC_APP_URL }}" ]; then echo "NEXT_PUBLIC_APP_URL is SET"; else echo "NEXT_PUBLIC_APP_URL is NOT SET"; fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.admin
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/rungame:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/rungame:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/rungame:buildcache,mode=max
          build-args: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            CACHE_DATABASE_URL=${{ secrets.CACHE_DATABASE_URL }}
            BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }}
            BETTER_AUTH_URL=${{ secrets.BETTER_AUTH_URL }}
            NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
            ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}

  deploy-to-vps:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy docker-compose to VPS
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "docker-compose.admin.yml"
          target: "/opt/1panel/docker/compose/rungame-admin/"
          strip_components: false

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            echo "=========================================="
            echo "ðŸš€ RunGame Admin è‡ªåŠ¨éƒ¨ç½²"
            echo "=========================================="
            echo ""
            echo "åˆ†æ”¯: ${{ github.ref_name }}"
            echo "æäº¤: ${{ github.sha }}"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="
            echo ""

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/1panel/docker/compose/rungame-admin

            # åˆ›å»º .env æ–‡ä»¶
            echo "ðŸ“ é…ç½®çŽ¯å¢ƒå˜é‡..."
            cat > .env << EOF
  NODE_ENV=production
  PORT=4000
  HOSTNAME=0.0.0.0
  NEXT_TELEMETRY_DISABLED=1
  DATABASE_URL="${{ secrets.DATABASE_URL }}"
  CACHE_DATABASE_URL="${{ secrets.CACHE_DATABASE_URL }}"
  BETTER_AUTH_SECRET="${{ secrets.BETTER_AUTH_SECRET }}"
  BETTER_AUTH_URL="${{ secrets.BETTER_AUTH_URL }}"
  NEXT_PUBLIC_APP_URL="${{ secrets.NEXT_PUBLIC_APP_URL }}"
  AUTH_TRUST_HOST=true
  ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}"
  EOF

            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ðŸ“¦ æ‹‰å–æœ€æ–°é•œåƒ..."
            docker-compose -f docker-compose.admin.yml pull

            # ä½¿ç”¨ Docker Compose å¯åŠ¨
            echo "ðŸš€ å¯åŠ¨æœåŠ¡..."
            docker-compose -f docker-compose.admin.yml up -d

            # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
            echo ""
            echo "=========================================="
            echo "ðŸ“Š æœåŠ¡çŠ¶æ€"
            echo "=========================================="
            docker-compose -f docker-compose.admin.yml ps
            echo ""

            # æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
            echo "ðŸ“‹ å¯åŠ¨æ—¥å¿—ï¼ˆæœ€è¿‘ 20 è¡Œï¼‰"
            echo "=========================================="
            docker-compose -f docker-compose.admin.yml logs --tail 20
            echo ""

            echo "=========================================="
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "=========================================="
            echo ""
            echo "è®¿é—®åœ°å€: https://gl.swhh.online"
            echo "ç™»å½•é‚®ç®±: yangnie2017@gmail.com"
            echo "ç™»å½•å¯†ç : admin123"

