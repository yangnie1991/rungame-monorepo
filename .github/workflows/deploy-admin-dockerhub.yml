name: Deploy Admin to Docker Hub & VPS

on:
  push:
    branches: [ "main" ]
    paths:
      # ä»…å½“ä»¥ä¸‹æ–‡ä»¶å˜åŠ¨æ—¶è§¦å‘ï¼Œé¿å…ä¿®æ”¹æ–‡æ¡£ä¹Ÿè§¦å‘æ„å»º
      - 'apps/admin/**'
      - 'packages/**'
      - 'Dockerfile.admin'
      - '.github/workflows/deploy-admin-dockerhub.yml'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹æŒ‰é’®è§¦å‘

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Debug Secrets Presence
        run: |
          echo "Checking secret presence..."
          if [ -n "${{ secrets.NEXTAUTH_URL }}" ]; then echo "NEXTAUTH_URL is SET"; else echo "NEXTAUTH_URL is NOT SET"; fi
          if [ -n "${{ secrets.DATABASE_URL }}" ]; then echo "DATABASE_URL is SET"; else echo "DATABASE_URL is NOT SET"; fi
          if [ -n "${{ secrets.NEXTAUTH_SECRET }}" ]; then echo "NEXTAUTH_SECRET is SET"; else echo "NEXTAUTH_SECRET is NOT SET"; fi
          if [ -n "${{ secrets.ENCRYPTION_KEY }}" ]; then echo "ENCRYPTION_KEY is SET"; else echo "ENCRYPTION_KEY is NOT SET"; fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.admin
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/rungame:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/rungame:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/rungame:buildcache,mode=max
          build-args: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}

  deploy-to-vps:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            echo "ğŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½²..."
            
            # ç™»å½• Docker Hub (é˜²æ­¢ç§æœ‰ä»“åº“æ— æ³•æ‹‰å–)
            # æ³¨æ„ï¼šå»ºè®®åœ¨æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨è¿è¡Œä¸€æ¬¡ docker loginï¼Œæ¯”åœ¨è¿™é‡Œæ˜æ–‡ä¼ è¾“å¯†ç æ›´å®‰å…¨
            # å¦‚æœæ˜¯å…¬å¼€ä»“åº“ï¼Œè¿™æ­¥å¯ä»¥çœç•¥
            echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¥ æ‹‰å–æ–°é•œåƒ..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/rungame:latest
            
            # åœæ­¢å¹¶åˆ é™¤å®¹å™¨
            docker rm -f rungame-admin || true
            
            # å¯åŠ¨æ–°å®¹ (è¿™é‡Œä½¿ç”¨æœ€ç®€å¯åŠ¨å‘½ä»¤ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦æŒ‚è½½å·)
            echo "ï¿½ å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name rungame-admin \
              --restart always \
              -p 4000:4000 \
              -e NODE_ENV=production \
              -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              -e NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}" \
              -e NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}" \
              -e ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}" \
              -e NEXT_TELEMETRY_DISABLED=1 \
              -e PORT=4000 \
              ${{ secrets.DOCKER_USERNAME }}/rungame:latest
              
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
