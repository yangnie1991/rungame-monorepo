name: Deploy Admin to VPS (PM2 - Auto)

on:
  push:
    branches:
      - main                        # ä¸»åˆ†æ”¯è‡ªåŠ¨è§¦å‘
    paths:
      - 'apps/admin/**'
      - 'packages/database/**'
      - 'packages/typescript-config/**'
      - 'packages/tailwind-config/**'
      - 'pnpm-lock.yaml'
      - 'package.json'
      - 'turbo.json'
      - 'ecosystem.config.js'
      - '.github/workflows/deploy-admin-pm2.yml'

  workflow_dispatch:  # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      branch:
        description: 'è¦éƒ¨ç½²çš„åˆ†æ”¯ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨å½“å‰åˆ†æ”¯ï¼‰'
        required: false
        default: ''

jobs:
  build-and-deploy:
    name: Build on GitHub and Deploy via PM2
    runs-on: ubuntu-22.04  # ä½¿ç”¨ Ubuntu 22.04 (ä¸å¤§å¤šæ•° VPS ä¸€è‡´)

    steps:
      # ==========================================
      # 1. æ£€å‡ºä»£ç 
      # ==========================================
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      # ==========================================
      # 2. å®‰è£… pnpmï¼ˆå¿…é¡»åœ¨ setup-node ä¹‹å‰ï¼‰
      # ==========================================
      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v3
        # è‡ªåŠ¨è¯»å– package.json ä¸­çš„ packageManager å­—æ®µï¼ˆpnpm@9.15.4ï¼‰

      # ==========================================
      # 3. è®¾ç½® Node.js ç¯å¢ƒ
      # ==========================================
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # ==========================================
      # 4. å®‰è£…ä¾èµ–
      # ==========================================
      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      # ==========================================
      # 4.5. æ£€æµ‹ VPS å¹³å°ï¼ˆä¼˜åŒ– Prisma äºŒè¿›åˆ¶ï¼‰- ä½¿ç”¨å¯é çš„è¾“å‡ºæ•è·
      # ==========================================
      - name: ğŸ” Detect VPS Platform
        id: platform
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
          VPS_PORT: ${{ secrets.VPS_PORT || 22 }}
        run: |
          echo "=========================================="
          echo "ğŸ” æ£€æµ‹ VPS å¹³å°"
          echo "=========================================="

          # è®¾ç½® SSH ç§é’¥
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # æ·»åŠ  VPS åˆ° known_hostsï¼ˆè·³è¿‡ä¸»æœºå¯†é’¥éªŒè¯ï¼‰
          ssh-keyscan -p ${VPS_PORT} -H ${VPS_HOST} >> ~/.ssh/known_hosts 2>/dev/null || true

          echo "è¿æ¥åˆ° VPS: ${VPS_USERNAME}@${VPS_HOST}:${VPS_PORT}"

          # ä¼ è¾“æ£€æµ‹è„šæœ¬åˆ° VPS
          scp -i ~/.ssh/deploy_key \
            -P ${VPS_PORT} \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            .github/detect-vps-platform.sh \
            ${VPS_USERNAME}@${VPS_HOST}:/tmp/detect-platform.sh

          # æ‰§è¡Œæ£€æµ‹è„šæœ¬å¹¶æ•è·è¾“å‡º
          DETECTION_RESULT=$(ssh -i ~/.ssh/deploy_key \
            -p ${VPS_PORT} \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ${VPS_USERNAME}@${VPS_HOST} \
            'bash /tmp/detect-platform.sh')

          # æ¸…ç† VPS ä¸Šçš„ä¸´æ—¶è„šæœ¬
          ssh -i ~/.ssh/deploy_key \
            -p ${VPS_PORT} \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ${VPS_USERNAME}@${VPS_HOST} \
            'rm -f /tmp/detect-platform.sh'

          # æ¸…ç†æœ¬åœ° SSH å¯†é’¥
          rm -f ~/.ssh/deploy_key

          # å¤„ç†æ£€æµ‹ç»“æœ
          BINARY_TARGET=$(echo "$DETECTION_RESULT" | tail -1 | tr -d ' \r\n')

          if [ -z "$BINARY_TARGET" ] || [ "$BINARY_TARGET" = "null" ]; then
            echo "âš ï¸  è‡ªåŠ¨æ£€æµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼: rhel-openssl-1.1.x"
            BINARY_TARGET="rhel-openssl-1.1.x"
          fi

          echo "=========================================="
          echo "âœ… æ£€æµ‹åˆ°çš„å¹³å°: $BINARY_TARGET"
          echo "=========================================="

          echo "BINARY_TARGET=$BINARY_TARGET" >> $GITHUB_OUTPUT

      # ==========================================
      # 5. ç”Ÿæˆä¼˜åŒ–çš„ Prisma Clientï¼ˆå•å¹³å°ï¼‰
      # ==========================================
      - name: ğŸ”§ Generate Optimized Prisma Client
        env:
          BINARY_TARGET: ${{ steps.platform.outputs.BINARY_TARGET }}
        run: |
          echo "=========================================="
          echo "ğŸ”§ ç”Ÿæˆä¼˜åŒ–çš„ Prisma Client"
          echo "=========================================="
          echo "ç›®æ ‡å¹³å°: $BINARY_TARGET"
          echo ""

          # å¤‡ä»½åŸå§‹ schema æ–‡ä»¶ï¼ˆä¸šåŠ¡æ•°æ®åº“ + ç®¡ç†æ•°æ®åº“ï¼‰
          cp packages/database/prisma/schema.prisma packages/database/prisma/schema.prisma.backup
          cp apps/admin/prisma/schema.prisma apps/admin/prisma/schema.prisma.backup

          # ğŸ”¥ å…³é”®ï¼šåˆ é™¤æ—§çš„ç”Ÿæˆæ–‡ä»¶ï¼ˆé˜²æ­¢ç¼“å­˜å¹²æ‰°ï¼‰
          echo "ğŸ—‘ï¸  åˆ é™¤æ—§çš„ Prisma Client ç”Ÿæˆæ–‡ä»¶..."
          rm -rf packages/database/src/generated/client
          rm -rf apps/admin/lib/generated/prisma-client
          echo "âœ… æ—§æ–‡ä»¶å·²åˆ é™¤"
          echo ""

          # åŠ¨æ€ä¿®æ”¹ binaryTargetsï¼ˆåªç”Ÿæˆ VPS ç›®æ ‡å¹³å°ï¼Œä¸ç”Ÿæˆ nativeï¼‰
          echo "ğŸ“ ä¿®æ”¹ä¸šåŠ¡æ•°æ®åº“ schema.prisma çš„ binaryTargets..."
          sed -i "s/binaryTargets = \[.*\]/binaryTargets = [\"$BINARY_TARGET\"]/" \
            packages/database/prisma/schema.prisma

          echo "ğŸ“ ä¿®æ”¹ç®¡ç†æ•°æ®åº“ schema.prisma çš„ binaryTargets..."
          sed -i "s/binaryTargets = \[.*\]/binaryTargets = [\"$BINARY_TARGET\"]/" \
            apps/admin/prisma/schema.prisma

          # æ˜¾ç¤ºä¿®æ”¹åçš„é…ç½®
          echo ""
          echo "ğŸ“‹ ä¿®æ”¹åçš„ binaryTargets é…ç½®:"
          echo "ä¸šåŠ¡æ•°æ®åº“ schema:"
          grep -A 5 "generator client" packages/database/prisma/schema.prisma
          echo ""
          echo "ç®¡ç†æ•°æ®åº“ schema:"
          grep -A 5 "generator client" apps/admin/prisma/schema.prisma
          echo ""

          # ç”Ÿæˆ Prisma Clientï¼ˆä¸šåŠ¡æ•°æ®åº“ + ç®¡ç†æ•°æ®åº“ï¼‰
          echo "â³ ç”Ÿæˆä¸šåŠ¡æ•°æ®åº“ Prisma Client..."
          pnpm db:generate

          echo ""
          echo "â³ ç”Ÿæˆç®¡ç†æ•°æ®åº“ Prisma Client..."
          pnpm --filter @rungame/admin db:generate

          # éªŒè¯ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶
          echo ""
          echo "=========================================="
          echo "âœ… ç”Ÿæˆå®Œæˆï¼Œæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶:"
          echo "=========================================="

          BUSINESS_CLIENT_DIR="packages/database/src/generated/client"
          ADMIN_CLIENT_DIR="apps/admin/lib/generated/prisma-client"

          if [ -d "$BUSINESS_CLIENT_DIR" ]; then
            echo "ğŸ“¦ ä¸šåŠ¡æ•°æ®åº“ Client ç›®å½•:"
            ls -lh $BUSINESS_CLIENT_DIR | grep -E "\.(so|node)" || echo "âš ï¸  æœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"
            BUSINESS_SIZE=$(du -sh $BUSINESS_CLIENT_DIR | cut -f1)
            echo "æ€»å¤§å°: $BUSINESS_SIZE"
          fi

          echo ""

          if [ -d "$ADMIN_CLIENT_DIR" ]; then
            echo "ğŸ“¦ ç®¡ç†æ•°æ®åº“ Client ç›®å½•:"
            ls -lh $ADMIN_CLIENT_DIR | grep -E "\.(so|node)" || echo "âš ï¸  æœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"
            ADMIN_SIZE=$(du -sh $ADMIN_CLIENT_DIR | cut -f1)
            echo "æ€»å¤§å°: $ADMIN_SIZE"
          fi

          echo ""
          echo "=========================================="
          echo "âœ… ä¼˜åŒ–å®Œæˆï¼äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°å‡å°‘ ~84%"
          echo "=========================================="

      # ==========================================
      # 6. æ„å»ºåº”ç”¨
      # ==========================================
      - name: ğŸ”¨ Build applications
        env:
          # æ„å»ºæ—¶éœ€è¦çš„ç¯å¢ƒå˜é‡ï¼ˆç”¨äº Next.js é¢„æ¸²æŸ“ï¼‰
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CACHE_DATABASE_URL: ${{ secrets.CACHE_DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        run: |
          echo "å¼€å§‹æ„å»º Admin åº”ç”¨..."
          pnpm build:admin

          echo "âœ… æ„å»ºå®Œæˆï¼Œæ£€æŸ¥äº§ç‰©:"
          ls -la apps/admin/.next
          echo "äº§ç‰©å¤§å°: $(du -sh apps/admin/.next | cut -f1)"

          # å¤åˆ¶é™æ€èµ„æºåˆ° standalone ç›®å½•ï¼ˆNext.js Standalone æ¨¡å¼å¿…éœ€ï¼‰
          echo "ğŸ“‹ å¤åˆ¶é™æ€èµ„æºåˆ° standalone ç›®å½•..."
          cp -r apps/admin/public apps/admin/.next/standalone/apps/admin/
          cp -r apps/admin/.next/static apps/admin/.next/standalone/apps/admin/.next/

          # ğŸ”‘ å¤åˆ¶ Prisma å¼•æ“æ–‡ä»¶åˆ° standalone ç›®å½•ï¼ˆä¿®å¤ Prisma Client å¼•æ“æ‰¾ä¸åˆ°é—®é¢˜ï¼‰
          echo ""
          echo "=========================================="
          echo "ğŸ“‹ å¤åˆ¶ Prisma å¼•æ“æ–‡ä»¶åˆ° standalone ç›®å½•"
          echo "=========================================="

          # åˆ›å»ºæ‰€æœ‰å¯èƒ½çš„ç›®æ ‡ç›®å½•ï¼ˆæ ¹æ® Prisma çš„æœç´¢è·¯å¾„ï¼‰
          mkdir -p apps/admin/.next/standalone/packages/database/src/generated/client
          mkdir -p apps/admin/.next/standalone/apps/admin/lib/generated/prisma-client
          mkdir -p apps/admin/.next/standalone/apps/admin/src/generated/client
          mkdir -p apps/admin/.next/standalone/apps/admin/.next/server

          # å¤åˆ¶ä¸šåŠ¡æ•°æ®åº“ Prisma Client åˆ°å¤šä¸ªä½ç½®
          echo "ğŸ“¦ å¤åˆ¶ä¸šåŠ¡æ•°æ®åº“ Prisma Client..."
          if [ -d "packages/database/src/generated/client" ]; then
            # ä½ç½® 1: packages/database è·¯å¾„ï¼ˆmonorepo ç»“æ„ï¼‰
            cp -r packages/database/src/generated/client/* apps/admin/.next/standalone/packages/database/src/generated/client/

            # ä½ç½® 2: apps/admin/src è·¯å¾„ï¼ˆPrisma æœç´¢è·¯å¾„ä¹‹ä¸€ï¼‰
            cp -r packages/database/src/generated/client/* apps/admin/.next/standalone/apps/admin/src/generated/client/

            # ä½ç½® 3: .next/server è·¯å¾„ï¼ˆNext.js ç¼–è¯‘è¾“å‡ºï¼‰
            cp -r packages/database/src/generated/client/*.node apps/admin/.next/standalone/apps/admin/.next/server/ 2>/dev/null || true

            echo "âœ… ä¸šåŠ¡æ•°æ®åº“ Prisma Client å·²å¤åˆ¶åˆ°å¤šä¸ªä½ç½®"

            # éªŒè¯å¼•æ“æ–‡ä»¶
            echo "ğŸ” éªŒè¯ä¸šåŠ¡æ•°æ®åº“å¼•æ“æ–‡ä»¶:"
            echo "ä½ç½® 1 (packages):"
            ls -lh apps/admin/.next/standalone/packages/database/src/generated/client/*.node 2>/dev/null | head -3 || echo "  æœªæ‰¾åˆ°"
            echo "ä½ç½® 2 (apps/admin/src):"
            ls -lh apps/admin/.next/standalone/apps/admin/src/generated/client/*.node 2>/dev/null | head -3 || echo "  æœªæ‰¾åˆ°"
          else
            echo "âŒ é”™è¯¯: packages/database/src/generated/client ä¸å­˜åœ¨"
            exit 1
          fi

          echo ""

          # å¤åˆ¶ç®¡ç†æ•°æ®åº“ Prisma Client
          echo "ğŸ“¦ å¤åˆ¶ç®¡ç†æ•°æ®åº“ Prisma Client..."
          if [ -d "apps/admin/lib/generated/prisma-client" ]; then
            # å¤åˆ¶å®Œæ•´ç›®å½•
            cp -r apps/admin/lib/generated/prisma-client/* apps/admin/.next/standalone/apps/admin/lib/generated/prisma-client/

            # é¢å¤–å¤åˆ¶å¼•æ“æ–‡ä»¶åˆ° .next/server
            cp -r apps/admin/lib/generated/prisma-client/*.node apps/admin/.next/standalone/apps/admin/.next/server/ 2>/dev/null || true

            echo "âœ… ç®¡ç†æ•°æ®åº“ Prisma Client å·²å¤åˆ¶"

            # éªŒè¯å¼•æ“æ–‡ä»¶
            echo "ğŸ” éªŒè¯ç®¡ç†æ•°æ®åº“å¼•æ“æ–‡ä»¶:"
            ls -lh apps/admin/.next/standalone/apps/admin/lib/generated/prisma-client/*.node 2>/dev/null | head -3 || echo "  æœªæ‰¾åˆ°"
          else
            echo "âŒ é”™è¯¯: apps/admin/lib/generated/prisma-client ä¸å­˜åœ¨"
            exit 1
          fi

          echo ""
          echo "=========================================="
          echo "âœ… æ‰€æœ‰ Prisma å¼•æ“æ–‡ä»¶å·²å¤åˆ¶åˆ°å¤šä¸ªæœç´¢è·¯å¾„"
          echo "=========================================="

          # ğŸ” æœ€ç»ˆéªŒè¯ï¼šæ£€æŸ¥æ‰€æœ‰ Prisma æœç´¢è·¯å¾„ä¸­çš„å¼•æ“æ–‡ä»¶
          echo ""
          echo "=========================================="
          echo "ğŸ” æœ€ç»ˆéªŒè¯ - æ£€æŸ¥ Prisma å¼•æ“æ–‡ä»¶å®Œæ•´æ€§"
          echo "=========================================="

          VALIDATION_FAILED=false

          # éªŒè¯ä¸šåŠ¡æ•°æ®åº“å¼•æ“æ–‡ä»¶ï¼ˆ3 ä¸ªä½ç½®ï¼‰
          echo "ğŸ“¦ ä¸šåŠ¡æ•°æ®åº“å¼•æ“æ–‡ä»¶:"

          echo "  ä½ç½® 1: packages/database/src/generated/client/"
          ENGINE_PATH_1="apps/admin/.next/standalone/packages/database/src/generated/client"
          if ls "$ENGINE_PATH_1"/*.node >/dev/null 2>&1; then
            ENGINE_COUNT_1=$(ls "$ENGINE_PATH_1"/*.node | wc -l)
            ENGINE_SIZE_1=$(du -sh "$ENGINE_PATH_1"/*.node | head -1 | cut -f1)
            echo "    âœ… æ‰¾åˆ° $ENGINE_COUNT_1 ä¸ªå¼•æ“æ–‡ä»¶ (å¤§å°: $ENGINE_SIZE_1)"
            ls -lh "$ENGINE_PATH_1"/*.node | head -3
          else
            echo "    âŒ æœªæ‰¾åˆ°å¼•æ“æ–‡ä»¶"
            VALIDATION_FAILED=true
          fi

          echo ""
          echo "  ä½ç½® 2: apps/admin/src/generated/client/"
          ENGINE_PATH_2="apps/admin/.next/standalone/apps/admin/src/generated/client"
          if ls "$ENGINE_PATH_2"/*.node >/dev/null 2>&1; then
            ENGINE_COUNT_2=$(ls "$ENGINE_PATH_2"/*.node | wc -l)
            ENGINE_SIZE_2=$(du -sh "$ENGINE_PATH_2"/*.node | head -1 | cut -f1)
            echo "    âœ… æ‰¾åˆ° $ENGINE_COUNT_2 ä¸ªå¼•æ“æ–‡ä»¶ (å¤§å°: $ENGINE_SIZE_2)"
            ls -lh "$ENGINE_PATH_2"/*.node | head -3
          else
            echo "    âŒ æœªæ‰¾åˆ°å¼•æ“æ–‡ä»¶"
            VALIDATION_FAILED=true
          fi

          echo ""
          echo "  ä½ç½® 3: apps/admin/.next/server/"
          ENGINE_PATH_3="apps/admin/.next/standalone/apps/admin/.next/server"
          if ls "$ENGINE_PATH_3"/*.node >/dev/null 2>&1; then
            ENGINE_COUNT_3=$(ls "$ENGINE_PATH_3"/*.node | wc -l)
            ENGINE_SIZE_3=$(du -sh "$ENGINE_PATH_3"/*.node | head -1 | cut -f1)
            echo "    âœ… æ‰¾åˆ° $ENGINE_COUNT_3 ä¸ªå¼•æ“æ–‡ä»¶ (å¤§å°: $ENGINE_SIZE_3)"
            ls -lh "$ENGINE_PATH_3"/*.node | head -3
          else
            echo "    âš ï¸  æœªæ‰¾åˆ°å¼•æ“æ–‡ä»¶ï¼ˆæ­¤ä½ç½®ä¸ºå¤‡ç”¨ï¼Œéå¿…éœ€ï¼‰"
          fi

          echo ""
          echo "ğŸ“¦ ç®¡ç†æ•°æ®åº“å¼•æ“æ–‡ä»¶:"
          echo "  ä½ç½®: apps/admin/lib/generated/prisma-client/"
          ENGINE_PATH_4="apps/admin/.next/standalone/apps/admin/lib/generated/prisma-client"
          if ls "$ENGINE_PATH_4"/*.node >/dev/null 2>&1; then
            ENGINE_COUNT_4=$(ls "$ENGINE_PATH_4"/*.node | wc -l)
            ENGINE_SIZE_4=$(du -sh "$ENGINE_PATH_4"/*.node | head -1 | cut -f1)
            echo "    âœ… æ‰¾åˆ° $ENGINE_COUNT_4 ä¸ªå¼•æ“æ–‡ä»¶ (å¤§å°: $ENGINE_SIZE_4)"
            ls -lh "$ENGINE_PATH_4"/*.node | head -3
          else
            echo "    âŒ æœªæ‰¾åˆ°å¼•æ“æ–‡ä»¶"
            VALIDATION_FAILED=true
          fi

          echo ""
          echo "=========================================="

          if [ "$VALIDATION_FAILED" = true ]; then
            echo "âŒ å¼•æ“æ–‡ä»¶éªŒè¯å¤±è´¥ï¼æŸäº›å¿…éœ€çš„å¼•æ“æ–‡ä»¶æœªæ‰¾åˆ°"
            echo ""
            echo "ğŸ“‹ è°ƒè¯•ä¿¡æ¯ - æ£€æŸ¥æºæ–‡ä»¶:"
            echo "ä¸šåŠ¡æ•°æ®åº“æºæ–‡ä»¶:"
            ls -lh packages/database/src/generated/client/*.node 2>/dev/null | head -3 || echo "  æºæ–‡ä»¶ä¸å­˜åœ¨"
            echo "ç®¡ç†æ•°æ®åº“æºæ–‡ä»¶:"
            ls -lh apps/admin/lib/generated/prisma-client/*.node 2>/dev/null | head -3 || echo "  æºæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          else
            echo "âœ… æ‰€æœ‰å¼•æ“æ–‡ä»¶éªŒè¯é€šè¿‡"
          fi

          echo "=========================================="

          echo "âœ… Standalone ç›®å½•å‡†å¤‡å®Œæˆ:"
          ls -la apps/admin/.next/standalone/apps/admin/
          echo "Standalone å¤§å°: $(du -sh apps/admin/.next/standalone | cut -f1)"

      # ==========================================
      # 7. æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶ï¼ˆStandalone æ¨¡å¼ï¼‰
      # ==========================================
      - name: ğŸ“¦ Package build artifacts
        run: |
          echo "æ‰“åŒ… Standalone éƒ¨ç½²æ–‡ä»¶..."

          # åˆ›å»ºæ—¥å¿—ç›®å½•ç»“æ„ï¼ˆé¿å… PM2 å¯åŠ¨æ—¶æŠ¥é”™ï¼‰
          mkdir -p logs

          # æ‰“åŒ… standalone ç›®å½•ï¼ˆå·²åŒ…å«æœ€å°åŒ–çš„ node_modules å’Œæ‰€æœ‰å¿…éœ€æ–‡ä»¶ï¼‰
          tar -czf rungame-pm2-admin.tar.gz \
            --exclude='*.log' \
            apps/admin/.next/standalone \
            ecosystem.config.js \
            logs

          echo "âœ… æ‰“åŒ…å®Œæˆ"
          echo "ğŸ“Š å‹ç¼©åŒ…å¤§å°: $(du -h rungame-pm2-admin.tar.gz | cut -f1)"

          # æ˜¾ç¤ºæ‰“åŒ…å†…å®¹
          echo "ğŸ“‹ æ‰“åŒ…å†…å®¹:"
          tar -tzf rungame-pm2-admin.tar.gz | head -20

      # ==========================================
      # 8. éªŒè¯ç¯å¢ƒå˜é‡ï¼ˆè°ƒè¯•ç”¨ï¼‰
      # ==========================================
      - name: ğŸ” Verify Environment Variables
        run: |
          echo "=========================================="
          echo "ğŸ” éªŒè¯ GitHub Secrets ç¯å¢ƒå˜é‡"
          echo "=========================================="

          # å®šä¹‰å¿…éœ€çš„ç¯å¢ƒå˜é‡åˆ—è¡¨
          REQUIRED_VARS=(
            "DATABASE_URL"
            "CACHE_DATABASE_URL"
            "NEXTAUTH_SECRET"
            "NEXTAUTH_URL"
            "ENCRYPTION_KEY"
            "R2_ACCOUNT_ID"
            "R2_ACCESS_KEY_ID"
            "R2_SECRET_ACCESS_KEY"
            "R2_BUCKET_NAME"
            "R2_PUBLIC_URL"
          )

          # æ£€æŸ¥æ¯ä¸ªå˜é‡
          ALL_SET=true
          for var_name in "${REQUIRED_VARS[@]}"; do
            # ä½¿ç”¨é—´æ¥å¼•ç”¨æ£€æŸ¥å˜é‡æ˜¯å¦è®¾ç½®
            var_value="${!var_name:-}"

            if [ -z "$var_value" ]; then
              echo "âŒ $var_name: æœªè®¾ç½®æˆ–ä¸ºç©º"
              ALL_SET=false
            else
              # å®‰å…¨æ‰“å°ï¼šåªæ˜¾ç¤ºé•¿åº¦å’Œå‰3ä¸ªå­—ç¬¦
              var_length=${#var_value}
              var_prefix="${var_value:0:3}"
              echo "âœ… $var_name: å·²è®¾ç½® (é•¿åº¦: $var_length, å‰ç¼€: ${var_prefix}***)"
            fi
          done

          echo "=========================================="

          # ğŸ” ç‰¹åˆ«éªŒè¯ï¼šDATABASE_URL å’Œ CACHE_DATABASE_URL æ ¼å¼
          echo ""
          echo "ğŸ” éªŒè¯æ•°æ®åº“ URL æ ¼å¼..."
          echo "=========================================="

          # ğŸ› è°ƒè¯•æ¨¡å¼ï¼šè§£æå¹¶æ˜¾ç¤º URL å„éƒ¨åˆ†ï¼ˆç»•è¿‡ GitHub Actions è‡ªåŠ¨éšè—ï¼‰
          echo "ğŸ“‹ DATABASE_URL è§£æï¼ˆå„éƒ¨åˆ†ï¼‰:"
          # æå–åè®®
          DB_PROTOCOL=$(echo "$DATABASE_URL" | sed -E 's|^([^:]+)://.*|\1|')
          echo "  åè®®: $DB_PROTOCOL"

          # æå–ç”¨æˆ·å
          DB_USER=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://([^:]+):.*|\1|')
          echo "  ç”¨æˆ·å: $DB_USER"

          # æå–å¯†ç ï¼ˆä»…æ˜¾ç¤ºé•¿åº¦å’Œå‰å2å­—ç¬¦ï¼‰
          DB_PASS=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^:]+:([^@]+)@.*|\1|')
          DB_PASS_LEN=${#DB_PASS}
          DB_PASS_PREFIX="${DB_PASS:0:2}"
          DB_PASS_SUFFIX="${DB_PASS: -2}"
          echo "  å¯†ç : ${DB_PASS_PREFIX}***${DB_PASS_SUFFIX} (é•¿åº¦: $DB_PASS_LEN)"

          # æå–ä¸»æœº
          DB_HOST=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@([^:/]+).*|\1|')
          echo "  ä¸»æœº: $DB_HOST"

          # æå–ç«¯å£
          DB_PORT=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^:]+:([0-9]+)/.*|\1|')
          echo "  ç«¯å£: $DB_PORT"

          # æå–æ•°æ®åº“å
          DB_NAME=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^/]+/([^?]+).*|\1|')
          echo "  æ•°æ®åº“: $DB_NAME"

          # æå–å‚æ•°
          DB_PARAMS=$(echo "$DATABASE_URL" | sed -E 's|^[^?]+\?(.*)|\1|')
          echo "  å‚æ•°: $DB_PARAMS"

          echo ""
          echo "ğŸ“‹ CACHE_DATABASE_URL è§£æï¼ˆå„éƒ¨åˆ†ï¼‰:"
          # åŒæ ·å¤„ç† CACHE_DATABASE_URL
          CACHE_PROTOCOL=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^([^:]+)://.*|\1|')
          echo "  åè®®: $CACHE_PROTOCOL"

          CACHE_USER=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://([^:]+):.*|\1|')
          echo "  ç”¨æˆ·å: $CACHE_USER"

          CACHE_PASS=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^:]+:([^@]+)@.*|\1|')
          CACHE_PASS_LEN=${#CACHE_PASS}
          CACHE_PASS_PREFIX="${CACHE_PASS:0:2}"
          CACHE_PASS_SUFFIX="${CACHE_PASS: -2}"
          echo "  å¯†ç : ${CACHE_PASS_PREFIX}***${CACHE_PASS_SUFFIX} (é•¿åº¦: $CACHE_PASS_LEN)"

          CACHE_HOST=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@([^:/]+).*|\1|')
          echo "  ä¸»æœº: $CACHE_HOST"

          CACHE_PORT=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^:]+:([0-9]+)/.*|\1|')
          echo "  ç«¯å£: $CACHE_PORT"

          CACHE_NAME=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^/]+/([^?]+).*|\1|')
          echo "  æ•°æ®åº“: $CACHE_NAME"

          CACHE_PARAMS=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^?]+\?(.*)|\1|')
          echo "  å‚æ•°: $CACHE_PARAMS"

          echo ""
          echo "=========================================="

          # éªŒè¯ DATABASE_URL
          if [[ "$DATABASE_URL" =~ ^postgresql:// ]] || [[ "$DATABASE_URL" =~ ^postgres:// ]]; then
            echo "âœ… DATABASE_URL: æ ¼å¼æ­£ç¡®ï¼ˆä»¥ postgresql:// å¼€å¤´ï¼‰"
          else
            echo "âŒ DATABASE_URL: æ ¼å¼é”™è¯¯ï¼"
            echo "   å¿…é¡»ä»¥ postgresql:// æˆ– postgres:// å¼€å¤´"
            echo "   æ­£ç¡®æ ¼å¼ç¤ºä¾‹: postgresql://user:password@host:port/database?schema=public"
            ALL_SET=false
          fi

          # éªŒè¯ CACHE_DATABASE_URL
          if [[ "$CACHE_DATABASE_URL" =~ ^postgresql:// ]] || [[ "$CACHE_DATABASE_URL" =~ ^postgres:// ]]; then
            echo "âœ… CACHE_DATABASE_URL: æ ¼å¼æ­£ç¡®ï¼ˆä»¥ postgresql:// å¼€å¤´ï¼‰"
          else
            echo "âŒ CACHE_DATABASE_URL: æ ¼å¼é”™è¯¯ï¼"
            echo "   å¿…é¡»ä»¥ postgresql:// æˆ– postgres:// å¼€å¤´"
            echo "   æ­£ç¡®æ ¼å¼ç¤ºä¾‹: postgresql://user:password@host:port/database?schema=public"
            ALL_SET=false
          fi

          echo "=========================================="

          if [ "$ALL_SET" = false ]; then
            echo "âŒ éªŒè¯å¤±è´¥ï¼Œéƒ¨ç½²ç»ˆæ­¢"
            echo "è¯·æ£€æŸ¥ GitHub Secrets é…ç½®"
            exit 1
          else
            echo "âœ… æ‰€æœ‰ç¯å¢ƒå˜é‡éªŒè¯é€šè¿‡"
          fi
          echo "=========================================="
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CACHE_DATABASE_URL: ${{ secrets.CACHE_DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}

      # ==========================================
      # 9. ä¼ è¾“åˆ° VPS
      # ==========================================
      - name: ğŸšš Transfer to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "rungame-pm2-admin.tar.gz"
          target: "/tmp/"
          timeout: 10m

      # ==========================================
      # 9. éƒ¨ç½²åˆ° VPS
      # ==========================================
      - name: ğŸš€ Deploy on VPS via PM2
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CACHE_DATABASE_URL: ${{ secrets.CACHE_DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          envs: DATABASE_URL,CACHE_DATABASE_URL,NEXTAUTH_SECRET,NEXTAUTH_URL,ENCRYPTION_KEY,R2_ACCOUNT_ID,R2_ACCESS_KEY_ID,R2_SECRET_ACCESS_KEY,R2_BUCKET_NAME,R2_PUBLIC_URL
          command_timeout: 30m
          script: |
            set -e

            echo "=========================================="
            echo "ğŸš€ RunGame Admin Standalone éƒ¨ç½²å¼€å§‹"
            echo "æ¨¡å¼: Next.js Standalone (æ— éœ€ä¾èµ–å®‰è£…)"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

            # ==========================================
            # ğŸ” éªŒè¯ç¯å¢ƒå˜é‡ä¼ é€’ï¼ˆVPS ç«¯ï¼‰
            # ==========================================
            echo ""
            echo "ğŸ” éªŒè¯ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®ä¼ é€’åˆ° VPS..."
            echo "=========================================="

            # å®šä¹‰å¿…éœ€çš„ç¯å¢ƒå˜é‡åˆ—è¡¨
            REQUIRED_VARS=(
              "DATABASE_URL"
              "CACHE_DATABASE_URL"
              "NEXTAUTH_SECRET"
              "NEXTAUTH_URL"
              "ENCRYPTION_KEY"
              "R2_ACCOUNT_ID"
              "R2_ACCESS_KEY_ID"
              "R2_SECRET_ACCESS_KEY"
              "R2_BUCKET_NAME"
              "R2_PUBLIC_URL"
            )

            # æ£€æŸ¥æ¯ä¸ªå˜é‡
            MISSING_VARS=()
            for var_name in "${REQUIRED_VARS[@]}"; do
              var_value=$(eval echo \$$var_name)

              if [ -z "$var_value" ]; then
                echo "âŒ $var_name: æœªä¼ é€’åˆ° VPS"
                MISSING_VARS+=("$var_name")
              else
                # å®‰å…¨æ‰“å°ï¼šåªæ˜¾ç¤ºé•¿åº¦å’Œå‰3ä¸ªå­—ç¬¦
                var_length=${#var_value}
                var_prefix="${var_value:0:3}"
                echo "âœ… $var_name: å·²æ¥æ”¶ (é•¿åº¦: $var_length, å‰ç¼€: ${var_prefix}***)"
              fi
            done

            echo "=========================================="
            if [ ${#MISSING_VARS[@]} -gt 0 ]; then
              echo "âŒ ä»¥ä¸‹ç¯å¢ƒå˜é‡æœªä¼ é€’åˆ° VPS:"
              printf '   - %s\n' "${MISSING_VARS[@]}"
              echo ""
              echo "è¯·æ£€æŸ¥ GitHub Actions é…ç½®ï¼š"
              echo "1. GitHub Secrets æ˜¯å¦æ­£ç¡®è®¾ç½®"
              echo "2. workflow yml çš„ 'env' éƒ¨åˆ†æ˜¯å¦åŒ…å«æ‰€æœ‰å˜é‡"
              echo "3. workflow yml çš„ 'envs' å‚æ•°æ˜¯å¦åŒ…å«æ‰€æœ‰å˜é‡å"
              exit 1
            else
              echo "âœ… æ‰€æœ‰ç¯å¢ƒå˜é‡å·²æˆåŠŸä¼ é€’åˆ° VPS"
            fi
            echo "=========================================="

            # ğŸ” ç‰¹åˆ«éªŒè¯ï¼šDATABASE_URL æ ¼å¼ï¼ˆVPS ç«¯ï¼‰
            echo ""
            echo "ğŸ” éªŒè¯æ•°æ®åº“ URL æ ¼å¼ï¼ˆVPS ç«¯ï¼‰..."
            echo "=========================================="

            # ğŸ› è°ƒè¯•æ¨¡å¼ï¼šè§£æå¹¶æ˜¾ç¤º URL å„éƒ¨åˆ†
            echo "ğŸ“‹ DATABASE_URL è§£æï¼ˆVPS ç«¯ï¼‰:"
            DB_PROTOCOL=$(echo "$DATABASE_URL" | sed -E 's|^([^:]+)://.*|\1|')
            echo "  åè®®: $DB_PROTOCOL"

            DB_USER=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://([^:]+):.*|\1|')
            echo "  ç”¨æˆ·å: $DB_USER"

            DB_PASS=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^:]+:([^@]+)@.*|\1|')
            DB_PASS_LEN=${#DB_PASS}
            DB_PASS_PREFIX="${DB_PASS:0:2}"
            DB_PASS_SUFFIX="${DB_PASS: -2}"
            echo "  å¯†ç : ${DB_PASS_PREFIX}***${DB_PASS_SUFFIX} (é•¿åº¦: $DB_PASS_LEN)"

            DB_HOST=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@([^:/]+).*|\1|')
            echo "  ä¸»æœº: $DB_HOST"

            DB_PORT=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^:]+:([0-9]+)/.*|\1|')
            echo "  ç«¯å£: $DB_PORT"

            DB_NAME=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^/]+/([^?]+).*|\1|')
            echo "  æ•°æ®åº“: $DB_NAME"

            DB_PARAMS=$(echo "$DATABASE_URL" | sed -E 's|^[^?]+\?(.*)|\1|')
            echo "  å‚æ•°: $DB_PARAMS"

            echo ""
            echo "ğŸ“‹ CACHE_DATABASE_URL è§£æï¼ˆVPS ç«¯ï¼‰:"
            CACHE_PROTOCOL=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^([^:]+)://.*|\1|')
            echo "  åè®®: $CACHE_PROTOCOL"

            CACHE_USER=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://([^:]+):.*|\1|')
            echo "  ç”¨æˆ·å: $CACHE_USER"

            CACHE_PASS=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^:]+:([^@]+)@.*|\1|')
            CACHE_PASS_LEN=${#CACHE_PASS}
            CACHE_PASS_PREFIX="${CACHE_PASS:0:2}"
            CACHE_PASS_SUFFIX="${CACHE_PASS: -2}"
            echo "  å¯†ç : ${CACHE_PASS_PREFIX}***${CACHE_PASS_SUFFIX} (é•¿åº¦: $CACHE_PASS_LEN)"

            CACHE_HOST=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@([^:/]+).*|\1|')
            echo "  ä¸»æœº: $CACHE_HOST"

            CACHE_PORT=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^:]+:([0-9]+)/.*|\1|')
            echo "  ç«¯å£: $CACHE_PORT"

            CACHE_NAME=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^/]+/([^?]+).*|\1|')
            echo "  æ•°æ®åº“: $CACHE_NAME"

            CACHE_PARAMS=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^?]+\?(.*)|\1|')
            echo "  å‚æ•°: $CACHE_PARAMS"

            echo ""
            echo "=========================================="

            FORMAT_ERROR=false

            # éªŒè¯ DATABASE_URL
            if [[ "$DATABASE_URL" =~ ^postgresql:// ]] || [[ "$DATABASE_URL" =~ ^postgres:// ]]; then
              echo "âœ… DATABASE_URL: æ ¼å¼æ­£ç¡®"
            else
              echo "âŒ DATABASE_URL: æ ¼å¼é”™è¯¯ï¼"
              echo "   å¿…é¡»ä»¥ postgresql:// æˆ– postgres:// å¼€å¤´"
              echo "   ç¤ºä¾‹: postgresql://user:password@host:5432/database?schema=public"
              FORMAT_ERROR=true
            fi

            # éªŒè¯ CACHE_DATABASE_URL
            if [[ "$CACHE_DATABASE_URL" =~ ^postgresql:// ]] || [[ "$CACHE_DATABASE_URL" =~ ^postgres:// ]]; then
              echo "âœ… CACHE_DATABASE_URL: æ ¼å¼æ­£ç¡®"
            else
              echo "âŒ CACHE_DATABASE_URL: æ ¼å¼é”™è¯¯ï¼"
              echo "   å¿…é¡»ä»¥ postgresql:// æˆ– postgres:// å¼€å¤´"
              echo "   ç¤ºä¾‹: postgresql://user:password@host:5432/database?schema=public"
              FORMAT_ERROR=true
            fi

            echo "=========================================="

            if [ "$FORMAT_ERROR" = true ]; then
              echo "âŒ æ•°æ®åº“ URL æ ¼å¼éªŒè¯å¤±è´¥ï¼Œéƒ¨ç½²ç»ˆæ­¢"
              echo ""
              echo "âš ï¸  è¯·æ›´æ–° GitHub Secrets ä¸­çš„æ•°æ®åº“ URLï¼š"
              echo "   1. è®¿é—® GitHub ä»“åº“ â†’ Settings â†’ Secrets"
              echo "   2. æ›´æ–° DATABASE_URL å’Œ CACHE_DATABASE_URL"
              echo "   3. ç¡®ä¿æ ¼å¼ä¸º: postgresql://user:pass@host:port/db?schema=public"
              exit 1
            fi

            echo ""

            # éƒ¨ç½²ç›®å½•
            DEPLOY_DIR="/www/wwwroot/rungame"

            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p $DEPLOY_DIR
            cd $DEPLOY_DIR

            # ğŸ§¹ æ¸…ç†æ—§çš„éƒ¨ç½²æ–‡ä»¶ï¼ˆé˜²æ­¢æ®‹ç•™å¯¼è‡´çš„é—®é¢˜ï¼‰
            echo ""
            echo "=========================================="
            echo "ğŸ§¹ æ¸…ç†æ—§çš„éƒ¨ç½²æ–‡ä»¶"
            echo "=========================================="

            if [ -d "apps/admin/.next" ]; then
              echo "ğŸ—‘ï¸  åˆ é™¤æ—§çš„ .next ç›®å½•..."
              rm -rf apps/admin/.next
            fi

            if [ -d "apps/admin/src/generated" ]; then
              echo "ğŸ—‘ï¸  åˆ é™¤æ—§çš„ Prisma ç”Ÿæˆæ–‡ä»¶..."
              rm -rf apps/admin/src/generated
            fi

            # æ¸…ç†å¯èƒ½çš„æ®‹ç•™ Prisma å¼•æ“æ–‡ä»¶
            echo "ğŸ—‘ï¸  æ¸…ç†å¯èƒ½çš„ Prisma å¼•æ“æ®‹ç•™..."
            find . -name "libquery_engine*.node" -type f -delete 2>/dev/null || true
            find . -name "libquery_engine*.dylib.node" -type f -delete 2>/dev/null || true
            find . -name ".prisma" -type d -exec rm -rf {} + 2>/dev/null || true

            echo "âœ… æ—§æ–‡ä»¶æ¸…ç†å®Œæˆ"
            echo "=========================================="
            echo ""

            # è§£å‹æ–°æ„å»ºï¼ˆStandalone åŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
            echo "ğŸ“¦ è§£å‹ Standalone æ„å»ºäº§ç‰©..."
            tar -xzf /tmp/rungame-pm2-admin.tar.gz
            rm -f /tmp/rungame-pm2-admin.tar.gz

            # éªŒè¯ Standalone ç›®å½•ç»“æ„
            echo "ğŸ” éªŒè¯ Standalone ç›®å½•..."
            if [ -f "apps/admin/.next/standalone/apps/admin/server.js" ]; then
              echo "âœ… Standalone server.js å­˜åœ¨"
            else
              echo "âŒ é”™è¯¯: server.js ä¸å­˜åœ¨"
              ls -la apps/admin/.next/standalone/apps/admin/ || true
              exit 1
            fi

            # éªŒè¯é™æ€èµ„æº
            if [ -d "apps/admin/.next/standalone/apps/admin/public" ] && [ -d "apps/admin/.next/standalone/apps/admin/.next/static" ]; then
              echo "âœ… é™æ€èµ„æºå·²å¤åˆ¶ï¼ˆpublic + .next/staticï¼‰"
            else
              echo "âš ï¸  è­¦å‘Š: é™æ€èµ„æºå¯èƒ½ç¼ºå¤±"
            fi

            # ğŸ” éªŒè¯ Prisma å¼•æ“æ–‡ä»¶ï¼ˆVPS ç«¯ï¼‰
            echo ""
            echo "=========================================="
            echo "ğŸ” VPS ç«¯éªŒè¯ - Prisma å¼•æ“æ–‡ä»¶"
            echo "=========================================="

            VPS_VALIDATION_FAILED=false

            # éªŒè¯ä¸šåŠ¡æ•°æ®åº“å¼•æ“æ–‡ä»¶
            echo "ğŸ“¦ ä¸šåŠ¡æ•°æ®åº“å¼•æ“æ–‡ä»¶:"

            echo "  ä½ç½® 1: packages/database/src/generated/client/"
            if ls apps/admin/.next/standalone/packages/database/src/generated/client/*.node >/dev/null 2>&1; then
              ENGINE_COUNT=$(ls apps/admin/.next/standalone/packages/database/src/generated/client/*.node | wc -l)
              echo "    âœ… æ‰¾åˆ° $ENGINE_COUNT ä¸ªå¼•æ“æ–‡ä»¶"
              ls -lh apps/admin/.next/standalone/packages/database/src/generated/client/*.node | head -2
            else
              echo "    âŒ æœªæ‰¾åˆ°å¼•æ“æ–‡ä»¶"
              VPS_VALIDATION_FAILED=true
            fi

            echo ""
            echo "  ä½ç½® 2: apps/admin/src/generated/client/"
            if ls apps/admin/.next/standalone/apps/admin/src/generated/client/*.node >/dev/null 2>&1; then
              ENGINE_COUNT=$(ls apps/admin/.next/standalone/apps/admin/src/generated/client/*.node | wc -l)
              echo "    âœ… æ‰¾åˆ° $ENGINE_COUNT ä¸ªå¼•æ“æ–‡ä»¶"
              ls -lh apps/admin/.next/standalone/apps/admin/src/generated/client/*.node | head -2
            else
              echo "    âŒ æœªæ‰¾åˆ°å¼•æ“æ–‡ä»¶"
              VPS_VALIDATION_FAILED=true
            fi

            echo ""
            echo "ğŸ“¦ ç®¡ç†æ•°æ®åº“å¼•æ“æ–‡ä»¶:"
            echo "  ä½ç½®: apps/admin/lib/generated/prisma-client/"
            if ls apps/admin/.next/standalone/apps/admin/lib/generated/prisma-client/*.node >/dev/null 2>&1; then
              ENGINE_COUNT=$(ls apps/admin/.next/standalone/apps/admin/lib/generated/prisma-client/*.node | wc -l)
              echo "    âœ… æ‰¾åˆ° $ENGINE_COUNT ä¸ªå¼•æ“æ–‡ä»¶"
              ls -lh apps/admin/.next/standalone/apps/admin/lib/generated/prisma-client/*.node | head -2
            else
              echo "    âŒ æœªæ‰¾åˆ°å¼•æ“æ–‡ä»¶"
              VPS_VALIDATION_FAILED=true
            fi

            echo ""
            echo "=========================================="

            if [ "$VPS_VALIDATION_FAILED" = true ]; then
              echo "âŒ VPS ç«¯å¼•æ“æ–‡ä»¶éªŒè¯å¤±è´¥ï¼"
              echo "æŸäº› Prisma å¼•æ“æ–‡ä»¶æœªæˆåŠŸä¼ è¾“åˆ° VPS"
              echo ""
              echo "ğŸ“‹ ç›®å½•ç»“æ„æ£€æŸ¥:"
              echo "Standalone ç›®å½•:"
              ls -la apps/admin/.next/standalone/apps/admin/ 2>/dev/null || echo "  ç›®å½•ä¸å­˜åœ¨"
              echo ""
              echo "è¯·æ£€æŸ¥æ„å»ºå’Œæ‰“åŒ…æ­¥éª¤æ˜¯å¦æ­£å¸¸æ‰§è¡Œ"
              exit 1
            else
              echo "âœ… VPS ç«¯æ‰€æœ‰ Prisma å¼•æ“æ–‡ä»¶éªŒè¯é€šè¿‡"
            fi

            echo "=========================================="
            echo ""

            # é…ç½®ç¯å¢ƒå˜é‡
            echo "âš™ï¸  é…ç½®ç¯å¢ƒå˜é‡..."

            # ğŸ”‘ é‡è¦ï¼šåœ¨ Monorepo æ ¹ç›®å½•åˆ›å»º .env æ–‡ä»¶ï¼ˆPM2 å·¥ä½œç›®å½•ï¼‰
            cat > .env << EOF
            # æ•°æ®åº“é…ç½®
            DATABASE_URL="${DATABASE_URL}"
            CACHE_DATABASE_URL="${CACHE_DATABASE_URL}"

            # NextAuth é…ç½®
            NEXTAUTH_SECRET="${NEXTAUTH_SECRET}"
            NEXTAUTH_URL="${NEXTAUTH_URL}"
            AUTH_TRUST_HOST=true

            # åŠ å¯†å¯†é’¥
            ENCRYPTION_KEY="${ENCRYPTION_KEY}"

            # R2 å­˜å‚¨é…ç½®
            R2_ACCOUNT_ID="${R2_ACCOUNT_ID}"
            R2_ACCESS_KEY_ID="${R2_ACCESS_KEY_ID}"
            R2_SECRET_ACCESS_KEY="${R2_SECRET_ACCESS_KEY}"
            R2_BUCKET_NAME="${R2_BUCKET_NAME}"
            R2_PUBLIC_URL="${R2_PUBLIC_URL}"

            # è¿è¡Œç¯å¢ƒ
            NODE_ENV=production
            PORT=4000
            HOSTNAME=0.0.0.0
            EOF

            echo "âœ… ç¯å¢ƒå˜é‡å·²å†™å…¥æ ¹ç›®å½• .env æ–‡ä»¶"

            # ğŸ”„ å¼ºåˆ¶å¤åˆ¶åˆ° standalone ç›®å½•ï¼ˆç¡®ä¿ä¸¤ä¸ªæ–‡ä»¶ä¸€è‡´ï¼‰
            cp -f .env apps/admin/.next/standalone/apps/admin/.env
            echo "âœ… å·²åŒæ­¥ .env åˆ° standalone ç›®å½•"

            # éªŒè¯å¤åˆ¶æ˜¯å¦æˆåŠŸ
            if [ -f "apps/admin/.next/standalone/apps/admin/.env" ]; then
              echo "âœ… Standalone .env æ–‡ä»¶å·²ç¡®è®¤å­˜åœ¨"
            else
              echo "âŒ é”™è¯¯ï¼šStandalone .env æ–‡ä»¶å¤åˆ¶å¤±è´¥"
              exit 1
            fi

            # ==========================================
            # ğŸ” éªŒè¯ .env æ–‡ä»¶å†…å®¹
            # ==========================================
            echo ""
            echo "ğŸ” éªŒè¯ .env æ–‡ä»¶å†…å®¹..."
            echo "=========================================="

            ENV_FILE=".env"  # éªŒè¯æ ¹ç›®å½•çš„ .env æ–‡ä»¶
            ENV_FILE_FULL_PATH="$DEPLOY_DIR/.env"

            echo "ğŸ“ .env æ–‡ä»¶ä½ç½®:"
            echo "   - ä¸»æ–‡ä»¶: $ENV_FILE_FULL_PATH"
            echo "   - å¤‡ä»½: $DEPLOY_DIR/apps/admin/.next/standalone/apps/admin/.env"
            echo ""

            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "$ENV_FILE" ]; then
              echo "âŒ .env æ–‡ä»¶ä¸å­˜åœ¨: $ENV_FILE_FULL_PATH"
              exit 1
            fi

            # æ£€æŸ¥å…³é”®å˜é‡æ˜¯å¦åœ¨æ–‡ä»¶ä¸­
            MISSING_IN_FILE=()
            for var_name in "${REQUIRED_VARS[@]}"; do
              if grep -q "^${var_name}=" "$ENV_FILE"; then
                # è·å–å˜é‡å€¼ï¼ˆå»é™¤å¼•å·å’Œå‰åç©ºæ ¼ï¼‰
                var_value=$(grep "^${var_name}=" "$ENV_FILE" | cut -d'=' -f2- | tr -d '"' | xargs)

                if [ -z "$var_value" ]; then
                  echo "âŒ $var_name: åœ¨ .env ä¸­ä¸ºç©º"
                  MISSING_IN_FILE+=("$var_name")
                else
                  var_length=${#var_value}
                  var_prefix="${var_value:0:3}"
                  echo "âœ… $var_name: å·²å†™å…¥ (é•¿åº¦: $var_length, å‰ç¼€: ${var_prefix}***)"
                fi
              else
                echo "âŒ $var_name: æœªæ‰¾åˆ°"
                MISSING_IN_FILE+=("$var_name")
              fi
            done

            echo "=========================================="
            if [ ${#MISSING_IN_FILE[@]} -gt 0 ]; then
              echo "âŒ .env æ–‡ä»¶ä¸­ç¼ºå¤±æˆ–ä¸ºç©ºçš„å˜é‡:"
              printf '   - %s\n' "${MISSING_IN_FILE[@]}"
              echo ""
              echo "ğŸ“„ .env æ–‡ä»¶å†…å®¹é¢„è§ˆï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰:"
              sed 's/\(=\).*/\1***/' "$ENV_FILE"
              exit 1
            else
              echo "âœ… .env æ–‡ä»¶æ‰€æœ‰å˜é‡éªŒè¯é€šè¿‡"
            fi
            echo "=========================================="
            echo ""

            # æ£€æŸ¥ PM2 æ˜¯å¦å®‰è£…
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¥ å®‰è£… PM2..."
              npm install -g pm2

              # è®¾ç½® PM2 å¼€æœºè‡ªå¯ï¼ˆä»…é¦–æ¬¡ï¼‰
              pm2 startup || true
            fi

            # ğŸ”¥ å¼ºåˆ¶åˆ é™¤æ—§è¿›ç¨‹å¹¶é‡æ–°å¯åŠ¨ï¼ˆç¡®ä¿ä½¿ç”¨æ–°é…ç½®ï¼‰
            echo "ğŸ”„ æ›´æ–° PM2 åº”ç”¨é…ç½®..."
            if pm2 list | grep -q "rungame-admin"; then
              echo "âš ï¸  æ£€æµ‹åˆ°æ—§è¿›ç¨‹ï¼Œå®Œå…¨åˆ é™¤å¹¶é‡æ–°åˆ›å»º..."

              # åˆ é™¤æ—§è¿›ç¨‹ï¼ˆç¡®ä¿æ—§é…ç½®ä¸æ®‹ç•™ï¼‰
              pm2 delete rungame-admin || true

              # ç­‰å¾…è¿›ç¨‹å®Œå…¨åœæ­¢
              sleep 2

              echo "âœ… æ—§è¿›ç¨‹å·²åˆ é™¤"
            fi

            # ä½¿ç”¨æ–°é…ç½®å¯åŠ¨
            echo "ğŸš€ ä½¿ç”¨æœ€æ–°é…ç½®å¯åŠ¨åº”ç”¨..."
            pm2 start ecosystem.config.js --only rungame-admin

            # ä¿å­˜ PM2 é…ç½®
            pm2 save

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 8

            # å¥åº·æ£€æŸ¥
            echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            for i in {1..15}; do
              if curl -f http://localhost:4000/api/health > /dev/null 2>&1; then
                echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
                break
              fi
              if [ $i -eq 15 ]; then
                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
                pm2 logs rungame-admin --lines 30 --nostream
                exit 1
              fi
              echo "ç­‰å¾…æœåŠ¡å°±ç»ª... ($i/15)"
              sleep 2
            done

            # æ˜¾ç¤º PM2 çŠ¶æ€
            echo "ğŸ“Š PM2 è¿›ç¨‹çŠ¶æ€:"
            pm2 list

            # æ˜¾ç¤ºå†…å­˜ä½¿ç”¨
            echo "ğŸ’¾ å†…å­˜ä½¿ç”¨æƒ…å†µ:"
            pm2 describe rungame-admin | grep -E "(memory|cpu)" || true

            echo "=========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸŒ è®¿é—®åœ°å€: ${NEXTAUTH_URL}"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

      # ==========================================
      # 10. éƒ¨ç½²æˆåŠŸé€šçŸ¥
      # ==========================================
      - name: âœ… Deployment Success
        if: success()
        run: |
          echo "=========================================="
          echo "âœ… PM2 éƒ¨ç½²æˆåŠŸï¼"
          echo "åº”ç”¨: RunGame Admin"
          echo "æ¨¡å¼: PM2 (è‡ªåŠ¨éƒ¨ç½²)"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "=========================================="

      # ==========================================
      # 11. éƒ¨ç½²å¤±è´¥é€šçŸ¥
      # ==========================================
      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "=========================================="
          echo "âŒ PM2 éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—"
          echo "=========================================="

      # ==========================================
      # 12. æ¢å¤åŸå§‹ Schemaï¼ˆæ¸…ç†ï¼‰
      # ==========================================
      - name: ğŸ”„ Restore Original Schemas
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        run: |
          echo "=========================================="
          echo "ğŸ”„ æ¢å¤åŸå§‹ Schema æ–‡ä»¶"
          echo "=========================================="

          # æ¢å¤ä¸šåŠ¡æ•°æ®åº“ schema
          if [ -f packages/database/prisma/schema.prisma.backup ]; then
            mv packages/database/prisma/schema.prisma.backup packages/database/prisma/schema.prisma
            echo "âœ… å·²æ¢å¤ä¸šåŠ¡æ•°æ®åº“ schema.prisma"
          else
            echo "â„¹ï¸  æœªæ‰¾åˆ°ä¸šåŠ¡æ•°æ®åº“ schema.prisma å¤‡ä»½æ–‡ä»¶ï¼ˆå¯èƒ½æœªæ‰§è¡Œä¼˜åŒ–æ­¥éª¤ï¼‰"
          fi

          # æ¢å¤ç®¡ç†æ•°æ®åº“ schema
          if [ -f apps/admin/prisma/schema.prisma.backup ]; then
            mv apps/admin/prisma/schema.prisma.backup apps/admin/prisma/schema.prisma
            echo "âœ… å·²æ¢å¤ç®¡ç†æ•°æ®åº“ schema.prisma"
          else
            echo "â„¹ï¸  æœªæ‰¾åˆ°ç®¡ç†æ•°æ®åº“ schema.prisma å¤‡ä»½æ–‡ä»¶ï¼ˆå¯èƒ½æœªæ‰§è¡Œä¼˜åŒ–æ­¥éª¤ï¼‰"
          fi

          echo "=========================================="
          echo "âœ… æ¸…ç†å®Œæˆ"
          echo "=========================================="
