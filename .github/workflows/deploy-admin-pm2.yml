name: Deploy Admin to VPS (PM2 - Auto)

on:
  push:
    branches:
      - main                        # ä¸»åˆ†æ”¯è‡ªåŠ¨è§¦å‘
    paths:
      - 'apps/admin/**'
      - 'packages/database/**'
      - 'packages/typescript-config/**'
      - 'packages/tailwind-config/**'
      - 'pnpm-lock.yaml'
      - 'package.json'
      - 'turbo.json'
      - 'ecosystem.config.js'
      - '.github/workflows/deploy-admin-pm2.yml'

  workflow_dispatch:  # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      branch:
        description: 'è¦éƒ¨ç½²çš„åˆ†æ”¯ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨å½“å‰åˆ†æ”¯ï¼‰'
        required: false
        default: ''

jobs:
  build-and-deploy:
    name: Build on GitHub and Deploy via PM2
    runs-on: ubuntu-22.04  # ä½¿ç”¨ Ubuntu 22.04 (ä¸å¤§å¤šæ•° VPS ä¸€è‡´)

    steps:
      # ==========================================
      # 1. æ£€å‡ºä»£ç 
      # ==========================================
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      # ==========================================
      # 2. å®‰è£… pnpmï¼ˆå¿…é¡»åœ¨ setup-node ä¹‹å‰ï¼‰
      # ==========================================
      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v3
        # è‡ªåŠ¨è¯»å– package.json ä¸­çš„ packageManager å­—æ®µï¼ˆpnpm@9.15.4ï¼‰

      # ==========================================
      # 3. è®¾ç½® Node.js ç¯å¢ƒ
      # ==========================================
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # ==========================================
      # 4. å®‰è£…ä¾èµ–
      # ==========================================
      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      # ==========================================
      # 4.5. æ£€æµ‹ VPS å¹³å°ï¼ˆä¼˜åŒ– Prisma äºŒè¿›åˆ¶ï¼‰
      # ==========================================
      - name: ğŸ” Detect VPS Platform
        id: detect-platform
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "=========================================="
            echo "ğŸ” æ£€æµ‹æœåŠ¡å™¨å¹³å°ä¿¡æ¯"
            echo "=========================================="

            # æ£€æµ‹æ“ä½œç³»ç»Ÿ
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              OS_ID="$ID"
              OS_VERSION="$VERSION_ID"
              echo "æ“ä½œç³»ç»Ÿ: $NAME $VERSION"
            else
              OS_ID="unknown"
              echo "âš ï¸  æ— æ³•æ£€æµ‹æ“ä½œç³»ç»Ÿ"
            fi

            # æ£€æµ‹ OpenSSL ç‰ˆæœ¬
            OPENSSL_VERSION=$(openssl version | grep -oP 'OpenSSL \K[0-9]+\.[0-9]+' || echo "unknown")
            echo "OpenSSL ç‰ˆæœ¬: $OPENSSL_VERSION"

            # ç¡®å®š Prisma binaryTarget
            if [[ "$OS_ID" == "debian" || "$OS_ID" == "ubuntu" ]]; then
              BASE_PLATFORM="debian-openssl"
            elif [[ "$OS_ID" == "rhel" || "$OS_ID" == "centos" || "$OS_ID" == "rocky" || "$OS_ID" == "almalinux" ]]; then
              BASE_PLATFORM="rhel-openssl"
            elif [[ "$OS_ID" == "alpine" ]]; then
              BASE_PLATFORM="linux-musl-openssl"
            else
              BASE_PLATFORM="debian-openssl"  # é»˜è®¤
              echo "âš ï¸  æœªè¯†åˆ«çš„ç³»ç»Ÿï¼Œä½¿ç”¨é»˜è®¤: debian-openssl"
            fi

            # ç¡®å®š OpenSSL ç‰ˆæœ¬åç¼€
            if [[ "$OPENSSL_VERSION" == "1.1"* ]]; then
              OPENSSL_SUFFIX="1.1.x"
            elif [[ "$OPENSSL_VERSION" == "3.0"* ]]; then
              OPENSSL_SUFFIX="3.0.x"
            else
              OPENSSL_SUFFIX="3.0.x"  # é»˜è®¤ä½¿ç”¨ 3.0.x
              echo "âš ï¸  æœªè¯†åˆ«çš„ OpenSSL ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤: 3.0.x"
            fi

            # ç»„åˆå®Œæ•´çš„ binaryTarget
            BINARY_TARGET="${BASE_PLATFORM}-${OPENSSL_SUFFIX}"

            echo "=========================================="
            echo "âœ… æ£€æµ‹ç»“æœ"
            echo "=========================================="
            echo "å¹³å°: $BASE_PLATFORM"
            echo "OpenSSL: $OPENSSL_SUFFIX"
            echo "Prisma binaryTarget: $BINARY_TARGET"
            echo "=========================================="

            # è¾“å‡ºåˆ° GitHub Actionsï¼ˆæ³¨æ„ï¼šssh-action ä¸æ”¯æŒ $GITHUB_OUTPUTï¼‰
            # æˆ‘ä»¬å°†é€šè¿‡è¾“å‡ºæ–‡æœ¬è®©ä¸‹ä¸€æ­¥è§£æ
            echo "BINARY_TARGET=$BINARY_TARGET"

      - name: ğŸ“‹ Save Detected Platform
        id: platform
        run: |
          # ä»ä¸Šä¸€æ­¥çš„è¾“å‡ºä¸­æå– BINARY_TARGET
          BINARY_TARGET=$(echo "${{ steps.detect-platform.outputs.stdout }}" | grep "BINARY_TARGET=" | cut -d'=' -f2)

          if [ -z "$BINARY_TARGET" ]; then
            echo "âš ï¸  æœªèƒ½æ£€æµ‹åˆ°å¹³å°ï¼Œä½¿ç”¨é»˜è®¤å€¼: debian-openssl-3.0.x"
            BINARY_TARGET="debian-openssl-3.0.x"
          fi

          echo "æ£€æµ‹åˆ°çš„å¹³å°: $BINARY_TARGET"
          echo "BINARY_TARGET=$BINARY_TARGET" >> $GITHUB_OUTPUT

      # ==========================================
      # 5. ç”Ÿæˆä¼˜åŒ–çš„ Prisma Clientï¼ˆå•å¹³å°ï¼‰
      # ==========================================
      - name: ğŸ”§ Generate Optimized Prisma Client
        env:
          BINARY_TARGET: ${{ steps.platform.outputs.BINARY_TARGET }}
        run: |
          echo "=========================================="
          echo "ğŸ”§ ç”Ÿæˆä¼˜åŒ–çš„ Prisma Client"
          echo "=========================================="
          echo "ç›®æ ‡å¹³å°: $BINARY_TARGET"
          echo ""

          # å¤‡ä»½åŸå§‹ schema æ–‡ä»¶
          cp packages/database/prisma/schema.prisma packages/database/prisma/schema.prisma.backup
          cp packages/database/prisma/schema-admin.prisma packages/database/prisma/schema-admin.prisma.backup

          # ğŸ”¥ å…³é”®ï¼šåˆ é™¤æ—§çš„ç”Ÿæˆæ–‡ä»¶ï¼ˆé˜²æ­¢ç¼“å­˜å¹²æ‰°ï¼‰
          echo "ğŸ—‘ï¸  åˆ é™¤æ—§çš„ Prisma Client ç”Ÿæˆæ–‡ä»¶..."
          rm -rf packages/database/src/generated/client
          rm -rf packages/database/src/generated/prisma-admin
          echo "âœ… æ—§æ–‡ä»¶å·²åˆ é™¤"
          echo ""

          # åŠ¨æ€ä¿®æ”¹ binaryTargetsï¼ˆåªä¿ç•™ native å’Œæ£€æµ‹åˆ°çš„å¹³å°ï¼‰
          echo "ğŸ“ ä¿®æ”¹ schema.prisma çš„ binaryTargets..."
          sed -i "s/binaryTargets = \[.*\]/binaryTargets = [\"native\", \"$BINARY_TARGET\"]/" \
            packages/database/prisma/schema.prisma

          echo "ğŸ“ ä¿®æ”¹ schema-admin.prisma çš„ binaryTargets..."
          sed -i "s/binaryTargets = \[.*\]/binaryTargets = [\"native\", \"$BINARY_TARGET\"]/" \
            packages/database/prisma/schema-admin.prisma

          # æ˜¾ç¤ºä¿®æ”¹åçš„é…ç½®
          echo ""
          echo "ğŸ“‹ ä¿®æ”¹åçš„ binaryTargets é…ç½®:"
          grep -A 5 "generator client" packages/database/prisma/schema.prisma
          echo ""

          # ç”Ÿæˆ Prisma Client
          echo "â³ ç”Ÿæˆ Prisma Client..."
          pnpm db:generate

          # éªŒè¯ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶
          echo ""
          echo "=========================================="
          echo "âœ… ç”Ÿæˆå®Œæˆï¼Œæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶:"
          echo "=========================================="

          CLIENT_DIR="packages/database/src/generated/client"
          ADMIN_DIR="packages/database/src/generated/prisma-admin"

          if [ -d "$CLIENT_DIR" ]; then
            echo "ğŸ“¦ Client ç›®å½•:"
            ls -lh $CLIENT_DIR | grep -E "\.(so|node)" || echo "âš ï¸  æœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"
            BINARY_SIZE=$(du -sh $CLIENT_DIR | cut -f1)
            echo "æ€»å¤§å°: $BINARY_SIZE"
          fi

          echo ""

          if [ -d "$ADMIN_DIR" ]; then
            echo "ğŸ“¦ Admin ç›®å½•:"
            ls -lh $ADMIN_DIR | grep -E "\.(so|node)" || echo "âš ï¸  æœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"
            ADMIN_SIZE=$(du -sh $ADMIN_DIR | cut -f1)
            echo "æ€»å¤§å°: $ADMIN_SIZE"
          fi

          echo ""
          echo "=========================================="
          echo "âœ… ä¼˜åŒ–å®Œæˆï¼äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°å‡å°‘ ~84%"
          echo "=========================================="

      # ==========================================
      # 6. æ„å»ºåº”ç”¨
      # ==========================================
      - name: ğŸ”¨ Build applications
        run: |
          echo "å¼€å§‹æ„å»º Admin åº”ç”¨..."
          pnpm build:admin

          echo "âœ… æ„å»ºå®Œæˆï¼Œæ£€æŸ¥äº§ç‰©:"
          ls -la apps/admin/.next
          echo "äº§ç‰©å¤§å°: $(du -sh apps/admin/.next | cut -f1)"

          # å¤åˆ¶é™æ€èµ„æºåˆ° standalone ç›®å½•ï¼ˆNext.js Standalone æ¨¡å¼å¿…éœ€ï¼‰
          echo "ğŸ“‹ å¤åˆ¶é™æ€èµ„æºåˆ° standalone ç›®å½•..."
          cp -r apps/admin/public apps/admin/.next/standalone/apps/admin/
          cp -r apps/admin/.next/static apps/admin/.next/standalone/apps/admin/.next/

          # ğŸ”‘ å¤åˆ¶ Prisma å¼•æ“æ–‡ä»¶åˆ° standalone ç›®å½•ï¼ˆä¿®å¤ Prisma Client å¼•æ“æ‰¾ä¸åˆ°é—®é¢˜ï¼‰
          echo "ğŸ“‹ å¤åˆ¶ Prisma å¼•æ“æ–‡ä»¶åˆ° standalone ç›®å½•..."

          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p apps/admin/.next/standalone/apps/admin/src/generated/client

          # å¤åˆ¶æ•´ä¸ª Prisma Client ç”Ÿæˆç›®å½•ï¼ˆåŒ…å«æ‰€æœ‰å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰
          cp -r packages/database/src/generated/client/* apps/admin/.next/standalone/apps/admin/src/generated/client/

          echo "âœ… Prisma å¼•æ“æ–‡ä»¶å·²å¤åˆ¶:"
          ls -lh apps/admin/.next/standalone/apps/admin/src/generated/client/*.node 2>/dev/null || echo "è­¦å‘Š: æœªæ‰¾åˆ° .node æ–‡ä»¶"

          echo "âœ… Standalone ç›®å½•å‡†å¤‡å®Œæˆ:"
          ls -la apps/admin/.next/standalone/apps/admin/
          echo "Standalone å¤§å°: $(du -sh apps/admin/.next/standalone | cut -f1)"

      # ==========================================
      # 7. æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶ï¼ˆStandalone æ¨¡å¼ï¼‰
      # ==========================================
      - name: ğŸ“¦ Package build artifacts
        run: |
          echo "æ‰“åŒ… Standalone éƒ¨ç½²æ–‡ä»¶..."

          # åˆ›å»ºæ—¥å¿—ç›®å½•ç»“æ„ï¼ˆé¿å… PM2 å¯åŠ¨æ—¶æŠ¥é”™ï¼‰
          mkdir -p logs

          # æ‰“åŒ… standalone ç›®å½•ï¼ˆå·²åŒ…å«æœ€å°åŒ–çš„ node_modules å’Œæ‰€æœ‰å¿…éœ€æ–‡ä»¶ï¼‰
          tar -czf rungame-pm2-admin.tar.gz \
            --exclude='*.log' \
            apps/admin/.next/standalone \
            ecosystem.config.js \
            logs

          echo "âœ… æ‰“åŒ…å®Œæˆ"
          echo "ğŸ“Š å‹ç¼©åŒ…å¤§å°: $(du -h rungame-pm2-admin.tar.gz | cut -f1)"

          # æ˜¾ç¤ºæ‰“åŒ…å†…å®¹
          echo "ğŸ“‹ æ‰“åŒ…å†…å®¹:"
          tar -tzf rungame-pm2-admin.tar.gz | head -20

      # ==========================================
      # 8. éªŒè¯ç¯å¢ƒå˜é‡ï¼ˆè°ƒè¯•ç”¨ï¼‰
      # ==========================================
      - name: ğŸ” Verify Environment Variables
        run: |
          echo "=========================================="
          echo "ğŸ” éªŒè¯ GitHub Secrets ç¯å¢ƒå˜é‡"
          echo "=========================================="

          # å®šä¹‰å¿…éœ€çš„ç¯å¢ƒå˜é‡åˆ—è¡¨
          REQUIRED_VARS=(
            "DATABASE_URL"
            "CACHE_DATABASE_URL"
            "NEXTAUTH_SECRET"
            "NEXTAUTH_URL"
            "ENCRYPTION_KEY"
            "R2_ACCOUNT_ID"
            "R2_ACCESS_KEY_ID"
            "R2_SECRET_ACCESS_KEY"
            "R2_BUCKET_NAME"
            "R2_PUBLIC_URL"
          )

          # æ£€æŸ¥æ¯ä¸ªå˜é‡
          ALL_SET=true
          for var_name in "${REQUIRED_VARS[@]}"; do
            # ä½¿ç”¨é—´æ¥å¼•ç”¨æ£€æŸ¥å˜é‡æ˜¯å¦è®¾ç½®
            var_value="${!var_name:-}"

            if [ -z "$var_value" ]; then
              echo "âŒ $var_name: æœªè®¾ç½®æˆ–ä¸ºç©º"
              ALL_SET=false
            else
              # å®‰å…¨æ‰“å°ï¼šåªæ˜¾ç¤ºé•¿åº¦å’Œå‰3ä¸ªå­—ç¬¦
              var_length=${#var_value}
              var_prefix="${var_value:0:3}"
              echo "âœ… $var_name: å·²è®¾ç½® (é•¿åº¦: $var_length, å‰ç¼€: ${var_prefix}***)"
            fi
          done

          echo "=========================================="

          # ğŸ” ç‰¹åˆ«éªŒè¯ï¼šDATABASE_URL å’Œ CACHE_DATABASE_URL æ ¼å¼
          echo ""
          echo "ğŸ” éªŒè¯æ•°æ®åº“ URL æ ¼å¼..."
          echo "=========================================="

          # ğŸ› è°ƒè¯•æ¨¡å¼ï¼šè§£æå¹¶æ˜¾ç¤º URL å„éƒ¨åˆ†ï¼ˆç»•è¿‡ GitHub Actions è‡ªåŠ¨éšè—ï¼‰
          echo "ğŸ“‹ DATABASE_URL è§£æï¼ˆå„éƒ¨åˆ†ï¼‰:"
          # æå–åè®®
          DB_PROTOCOL=$(echo "$DATABASE_URL" | sed -E 's|^([^:]+)://.*|\1|')
          echo "  åè®®: $DB_PROTOCOL"

          # æå–ç”¨æˆ·å
          DB_USER=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://([^:]+):.*|\1|')
          echo "  ç”¨æˆ·å: $DB_USER"

          # æå–å¯†ç ï¼ˆä»…æ˜¾ç¤ºé•¿åº¦å’Œå‰å2å­—ç¬¦ï¼‰
          DB_PASS=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^:]+:([^@]+)@.*|\1|')
          DB_PASS_LEN=${#DB_PASS}
          DB_PASS_PREFIX="${DB_PASS:0:2}"
          DB_PASS_SUFFIX="${DB_PASS: -2}"
          echo "  å¯†ç : ${DB_PASS_PREFIX}***${DB_PASS_SUFFIX} (é•¿åº¦: $DB_PASS_LEN)"

          # æå–ä¸»æœº
          DB_HOST=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@([^:/]+).*|\1|')
          echo "  ä¸»æœº: $DB_HOST"

          # æå–ç«¯å£
          DB_PORT=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^:]+:([0-9]+)/.*|\1|')
          echo "  ç«¯å£: $DB_PORT"

          # æå–æ•°æ®åº“å
          DB_NAME=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^/]+/([^?]+).*|\1|')
          echo "  æ•°æ®åº“: $DB_NAME"

          # æå–å‚æ•°
          DB_PARAMS=$(echo "$DATABASE_URL" | sed -E 's|^[^?]+\?(.*)|\1|')
          echo "  å‚æ•°: $DB_PARAMS"

          echo ""
          echo "ğŸ“‹ CACHE_DATABASE_URL è§£æï¼ˆå„éƒ¨åˆ†ï¼‰:"
          # åŒæ ·å¤„ç† CACHE_DATABASE_URL
          CACHE_PROTOCOL=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^([^:]+)://.*|\1|')
          echo "  åè®®: $CACHE_PROTOCOL"

          CACHE_USER=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://([^:]+):.*|\1|')
          echo "  ç”¨æˆ·å: $CACHE_USER"

          CACHE_PASS=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^:]+:([^@]+)@.*|\1|')
          CACHE_PASS_LEN=${#CACHE_PASS}
          CACHE_PASS_PREFIX="${CACHE_PASS:0:2}"
          CACHE_PASS_SUFFIX="${CACHE_PASS: -2}"
          echo "  å¯†ç : ${CACHE_PASS_PREFIX}***${CACHE_PASS_SUFFIX} (é•¿åº¦: $CACHE_PASS_LEN)"

          CACHE_HOST=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@([^:/]+).*|\1|')
          echo "  ä¸»æœº: $CACHE_HOST"

          CACHE_PORT=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^:]+:([0-9]+)/.*|\1|')
          echo "  ç«¯å£: $CACHE_PORT"

          CACHE_NAME=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^/]+/([^?]+).*|\1|')
          echo "  æ•°æ®åº“: $CACHE_NAME"

          CACHE_PARAMS=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^?]+\?(.*)|\1|')
          echo "  å‚æ•°: $CACHE_PARAMS"

          echo ""
          echo "=========================================="

          # éªŒè¯ DATABASE_URL
          if [[ "$DATABASE_URL" =~ ^postgresql:// ]] || [[ "$DATABASE_URL" =~ ^postgres:// ]]; then
            echo "âœ… DATABASE_URL: æ ¼å¼æ­£ç¡®ï¼ˆä»¥ postgresql:// å¼€å¤´ï¼‰"
          else
            echo "âŒ DATABASE_URL: æ ¼å¼é”™è¯¯ï¼"
            echo "   å¿…é¡»ä»¥ postgresql:// æˆ– postgres:// å¼€å¤´"
            echo "   æ­£ç¡®æ ¼å¼ç¤ºä¾‹: postgresql://user:password@host:port/database?schema=public"
            ALL_SET=false
          fi

          # éªŒè¯ CACHE_DATABASE_URL
          if [[ "$CACHE_DATABASE_URL" =~ ^postgresql:// ]] || [[ "$CACHE_DATABASE_URL" =~ ^postgres:// ]]; then
            echo "âœ… CACHE_DATABASE_URL: æ ¼å¼æ­£ç¡®ï¼ˆä»¥ postgresql:// å¼€å¤´ï¼‰"
          else
            echo "âŒ CACHE_DATABASE_URL: æ ¼å¼é”™è¯¯ï¼"
            echo "   å¿…é¡»ä»¥ postgresql:// æˆ– postgres:// å¼€å¤´"
            echo "   æ­£ç¡®æ ¼å¼ç¤ºä¾‹: postgresql://user:password@host:port/database?schema=public"
            ALL_SET=false
          fi

          echo "=========================================="

          if [ "$ALL_SET" = false ]; then
            echo "âŒ éªŒè¯å¤±è´¥ï¼Œéƒ¨ç½²ç»ˆæ­¢"
            echo "è¯·æ£€æŸ¥ GitHub Secrets é…ç½®"
            exit 1
          else
            echo "âœ… æ‰€æœ‰ç¯å¢ƒå˜é‡éªŒè¯é€šè¿‡"
          fi
          echo "=========================================="
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CACHE_DATABASE_URL: ${{ secrets.CACHE_DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}

      # ==========================================
      # 9. ä¼ è¾“åˆ° VPS
      # ==========================================
      - name: ğŸšš Transfer to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "rungame-pm2-admin.tar.gz"
          target: "/tmp/"
          timeout: 10m

      # ==========================================
      # 9. éƒ¨ç½²åˆ° VPS
      # ==========================================
      - name: ğŸš€ Deploy on VPS via PM2
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CACHE_DATABASE_URL: ${{ secrets.CACHE_DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          envs: DATABASE_URL,CACHE_DATABASE_URL,NEXTAUTH_SECRET,NEXTAUTH_URL,ENCRYPTION_KEY,R2_ACCOUNT_ID,R2_ACCESS_KEY_ID,R2_SECRET_ACCESS_KEY,R2_BUCKET_NAME,R2_PUBLIC_URL
          command_timeout: 30m
          script: |
            set -e

            echo "=========================================="
            echo "ğŸš€ RunGame Admin Standalone éƒ¨ç½²å¼€å§‹"
            echo "æ¨¡å¼: Next.js Standalone (æ— éœ€ä¾èµ–å®‰è£…)"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

            # ==========================================
            # ğŸ” éªŒè¯ç¯å¢ƒå˜é‡ä¼ é€’ï¼ˆVPS ç«¯ï¼‰
            # ==========================================
            echo ""
            echo "ğŸ” éªŒè¯ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®ä¼ é€’åˆ° VPS..."
            echo "=========================================="

            # å®šä¹‰å¿…éœ€çš„ç¯å¢ƒå˜é‡åˆ—è¡¨
            REQUIRED_VARS=(
              "DATABASE_URL"
              "CACHE_DATABASE_URL"
              "NEXTAUTH_SECRET"
              "NEXTAUTH_URL"
              "ENCRYPTION_KEY"
              "R2_ACCOUNT_ID"
              "R2_ACCESS_KEY_ID"
              "R2_SECRET_ACCESS_KEY"
              "R2_BUCKET_NAME"
              "R2_PUBLIC_URL"
            )

            # æ£€æŸ¥æ¯ä¸ªå˜é‡
            MISSING_VARS=()
            for var_name in "${REQUIRED_VARS[@]}"; do
              var_value=$(eval echo \$$var_name)

              if [ -z "$var_value" ]; then
                echo "âŒ $var_name: æœªä¼ é€’åˆ° VPS"
                MISSING_VARS+=("$var_name")
              else
                # å®‰å…¨æ‰“å°ï¼šåªæ˜¾ç¤ºé•¿åº¦å’Œå‰3ä¸ªå­—ç¬¦
                var_length=${#var_value}
                var_prefix="${var_value:0:3}"
                echo "âœ… $var_name: å·²æ¥æ”¶ (é•¿åº¦: $var_length, å‰ç¼€: ${var_prefix}***)"
              fi
            done

            echo "=========================================="
            if [ ${#MISSING_VARS[@]} -gt 0 ]; then
              echo "âŒ ä»¥ä¸‹ç¯å¢ƒå˜é‡æœªä¼ é€’åˆ° VPS:"
              printf '   - %s\n' "${MISSING_VARS[@]}"
              echo ""
              echo "è¯·æ£€æŸ¥ GitHub Actions é…ç½®ï¼š"
              echo "1. GitHub Secrets æ˜¯å¦æ­£ç¡®è®¾ç½®"
              echo "2. workflow yml çš„ 'env' éƒ¨åˆ†æ˜¯å¦åŒ…å«æ‰€æœ‰å˜é‡"
              echo "3. workflow yml çš„ 'envs' å‚æ•°æ˜¯å¦åŒ…å«æ‰€æœ‰å˜é‡å"
              exit 1
            else
              echo "âœ… æ‰€æœ‰ç¯å¢ƒå˜é‡å·²æˆåŠŸä¼ é€’åˆ° VPS"
            fi
            echo "=========================================="

            # ğŸ” ç‰¹åˆ«éªŒè¯ï¼šDATABASE_URL æ ¼å¼ï¼ˆVPS ç«¯ï¼‰
            echo ""
            echo "ğŸ” éªŒè¯æ•°æ®åº“ URL æ ¼å¼ï¼ˆVPS ç«¯ï¼‰..."
            echo "=========================================="

            # ğŸ› è°ƒè¯•æ¨¡å¼ï¼šè§£æå¹¶æ˜¾ç¤º URL å„éƒ¨åˆ†
            echo "ğŸ“‹ DATABASE_URL è§£æï¼ˆVPS ç«¯ï¼‰:"
            DB_PROTOCOL=$(echo "$DATABASE_URL" | sed -E 's|^([^:]+)://.*|\1|')
            echo "  åè®®: $DB_PROTOCOL"

            DB_USER=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://([^:]+):.*|\1|')
            echo "  ç”¨æˆ·å: $DB_USER"

            DB_PASS=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^:]+:([^@]+)@.*|\1|')
            DB_PASS_LEN=${#DB_PASS}
            DB_PASS_PREFIX="${DB_PASS:0:2}"
            DB_PASS_SUFFIX="${DB_PASS: -2}"
            echo "  å¯†ç : ${DB_PASS_PREFIX}***${DB_PASS_SUFFIX} (é•¿åº¦: $DB_PASS_LEN)"

            DB_HOST=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@([^:/]+).*|\1|')
            echo "  ä¸»æœº: $DB_HOST"

            DB_PORT=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^:]+:([0-9]+)/.*|\1|')
            echo "  ç«¯å£: $DB_PORT"

            DB_NAME=$(echo "$DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^/]+/([^?]+).*|\1|')
            echo "  æ•°æ®åº“: $DB_NAME"

            DB_PARAMS=$(echo "$DATABASE_URL" | sed -E 's|^[^?]+\?(.*)|\1|')
            echo "  å‚æ•°: $DB_PARAMS"

            echo ""
            echo "ğŸ“‹ CACHE_DATABASE_URL è§£æï¼ˆVPS ç«¯ï¼‰:"
            CACHE_PROTOCOL=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^([^:]+)://.*|\1|')
            echo "  åè®®: $CACHE_PROTOCOL"

            CACHE_USER=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://([^:]+):.*|\1|')
            echo "  ç”¨æˆ·å: $CACHE_USER"

            CACHE_PASS=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^:]+:([^@]+)@.*|\1|')
            CACHE_PASS_LEN=${#CACHE_PASS}
            CACHE_PASS_PREFIX="${CACHE_PASS:0:2}"
            CACHE_PASS_SUFFIX="${CACHE_PASS: -2}"
            echo "  å¯†ç : ${CACHE_PASS_PREFIX}***${CACHE_PASS_SUFFIX} (é•¿åº¦: $CACHE_PASS_LEN)"

            CACHE_HOST=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@([^:/]+).*|\1|')
            echo "  ä¸»æœº: $CACHE_HOST"

            CACHE_PORT=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^:]+:([0-9]+)/.*|\1|')
            echo "  ç«¯å£: $CACHE_PORT"

            CACHE_NAME=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^:]+://[^@]+@[^/]+/([^?]+).*|\1|')
            echo "  æ•°æ®åº“: $CACHE_NAME"

            CACHE_PARAMS=$(echo "$CACHE_DATABASE_URL" | sed -E 's|^[^?]+\?(.*)|\1|')
            echo "  å‚æ•°: $CACHE_PARAMS"

            echo ""
            echo "=========================================="

            FORMAT_ERROR=false

            # éªŒè¯ DATABASE_URL
            if [[ "$DATABASE_URL" =~ ^postgresql:// ]] || [[ "$DATABASE_URL" =~ ^postgres:// ]]; then
              echo "âœ… DATABASE_URL: æ ¼å¼æ­£ç¡®"
            else
              echo "âŒ DATABASE_URL: æ ¼å¼é”™è¯¯ï¼"
              echo "   å¿…é¡»ä»¥ postgresql:// æˆ– postgres:// å¼€å¤´"
              echo "   ç¤ºä¾‹: postgresql://user:password@host:5432/database?schema=public"
              FORMAT_ERROR=true
            fi

            # éªŒè¯ CACHE_DATABASE_URL
            if [[ "$CACHE_DATABASE_URL" =~ ^postgresql:// ]] || [[ "$CACHE_DATABASE_URL" =~ ^postgres:// ]]; then
              echo "âœ… CACHE_DATABASE_URL: æ ¼å¼æ­£ç¡®"
            else
              echo "âŒ CACHE_DATABASE_URL: æ ¼å¼é”™è¯¯ï¼"
              echo "   å¿…é¡»ä»¥ postgresql:// æˆ– postgres:// å¼€å¤´"
              echo "   ç¤ºä¾‹: postgresql://user:password@host:5432/database?schema=public"
              FORMAT_ERROR=true
            fi

            echo "=========================================="

            if [ "$FORMAT_ERROR" = true ]; then
              echo "âŒ æ•°æ®åº“ URL æ ¼å¼éªŒè¯å¤±è´¥ï¼Œéƒ¨ç½²ç»ˆæ­¢"
              echo ""
              echo "âš ï¸  è¯·æ›´æ–° GitHub Secrets ä¸­çš„æ•°æ®åº“ URLï¼š"
              echo "   1. è®¿é—® GitHub ä»“åº“ â†’ Settings â†’ Secrets"
              echo "   2. æ›´æ–° DATABASE_URL å’Œ CACHE_DATABASE_URL"
              echo "   3. ç¡®ä¿æ ¼å¼ä¸º: postgresql://user:pass@host:port/db?schema=public"
              exit 1
            fi

            echo ""

            # éƒ¨ç½²ç›®å½•
            DEPLOY_DIR="/www/wwwroot/rungame"

            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p $DEPLOY_DIR
            cd $DEPLOY_DIR

            # è§£å‹æ–°æ„å»ºï¼ˆStandalone åŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
            echo "ğŸ“¦ è§£å‹ Standalone æ„å»ºäº§ç‰©..."
            tar -xzf /tmp/rungame-pm2-admin.tar.gz
            rm -f /tmp/rungame-pm2-admin.tar.gz

            # éªŒè¯ Standalone ç›®å½•ç»“æ„
            echo "ğŸ” éªŒè¯ Standalone ç›®å½•..."
            if [ -f "apps/admin/.next/standalone/apps/admin/server.js" ]; then
              echo "âœ… Standalone server.js å­˜åœ¨"
            else
              echo "âŒ é”™è¯¯: server.js ä¸å­˜åœ¨"
              ls -la apps/admin/.next/standalone/apps/admin/ || true
              exit 1
            fi

            # éªŒè¯é™æ€èµ„æº
            if [ -d "apps/admin/.next/standalone/apps/admin/public" ] && [ -d "apps/admin/.next/standalone/apps/admin/.next/static" ]; then
              echo "âœ… é™æ€èµ„æºå·²å¤åˆ¶ï¼ˆpublic + .next/staticï¼‰"
            else
              echo "âš ï¸  è­¦å‘Š: é™æ€èµ„æºå¯èƒ½ç¼ºå¤±"
            fi

            # é…ç½®ç¯å¢ƒå˜é‡
            echo "âš™ï¸  é…ç½®ç¯å¢ƒå˜é‡..."

            # ğŸ”‘ é‡è¦ï¼šåœ¨ Monorepo æ ¹ç›®å½•åˆ›å»º .env æ–‡ä»¶ï¼ˆPM2 å·¥ä½œç›®å½•ï¼‰
            cat > .env << EOF
            # æ•°æ®åº“é…ç½®
            DATABASE_URL="${DATABASE_URL}"
            CACHE_DATABASE_URL="${CACHE_DATABASE_URL}"

            # NextAuth é…ç½®
            NEXTAUTH_SECRET="${NEXTAUTH_SECRET}"
            NEXTAUTH_URL="${NEXTAUTH_URL}"
            NEXTAUTH_TRUST_HOST=true

            # åŠ å¯†å¯†é’¥
            ENCRYPTION_KEY="${ENCRYPTION_KEY}"

            # R2 å­˜å‚¨é…ç½®
            R2_ACCOUNT_ID="${R2_ACCOUNT_ID}"
            R2_ACCESS_KEY_ID="${R2_ACCESS_KEY_ID}"
            R2_SECRET_ACCESS_KEY="${R2_SECRET_ACCESS_KEY}"
            R2_BUCKET_NAME="${R2_BUCKET_NAME}"
            R2_PUBLIC_URL="${R2_PUBLIC_URL}"

            # è¿è¡Œç¯å¢ƒ
            NODE_ENV=production
            PORT=4000
            HOSTNAME=0.0.0.0
            EOF

            echo "âœ… ç¯å¢ƒå˜é‡å·²å†™å…¥æ ¹ç›®å½• .env æ–‡ä»¶"

            # åŒæ—¶åœ¨ standalone ç›®å½•ä¹Ÿåˆ›å»ºä¸€ä»½ï¼ˆä½œä¸ºå¤‡ä»½ï¼‰
            cp .env apps/admin/.next/standalone/apps/admin/.env 2>/dev/null || true

            # ==========================================
            # ğŸ” éªŒè¯ .env æ–‡ä»¶å†…å®¹
            # ==========================================
            echo ""
            echo "ğŸ” éªŒè¯ .env æ–‡ä»¶å†…å®¹..."
            echo "=========================================="

            ENV_FILE=".env"  # éªŒè¯æ ¹ç›®å½•çš„ .env æ–‡ä»¶
            ENV_FILE_FULL_PATH="$DEPLOY_DIR/.env"

            echo "ğŸ“ .env æ–‡ä»¶ä½ç½®:"
            echo "   - ä¸»æ–‡ä»¶: $ENV_FILE_FULL_PATH"
            echo "   - å¤‡ä»½: $DEPLOY_DIR/apps/admin/.next/standalone/apps/admin/.env"
            echo ""

            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "$ENV_FILE" ]; then
              echo "âŒ .env æ–‡ä»¶ä¸å­˜åœ¨: $ENV_FILE_FULL_PATH"
              exit 1
            fi

            # æ£€æŸ¥å…³é”®å˜é‡æ˜¯å¦åœ¨æ–‡ä»¶ä¸­
            MISSING_IN_FILE=()
            for var_name in "${REQUIRED_VARS[@]}"; do
              if grep -q "^${var_name}=" "$ENV_FILE"; then
                # è·å–å˜é‡å€¼ï¼ˆå»é™¤å¼•å·å’Œå‰åç©ºæ ¼ï¼‰
                var_value=$(grep "^${var_name}=" "$ENV_FILE" | cut -d'=' -f2- | tr -d '"' | xargs)

                if [ -z "$var_value" ]; then
                  echo "âŒ $var_name: åœ¨ .env ä¸­ä¸ºç©º"
                  MISSING_IN_FILE+=("$var_name")
                else
                  var_length=${#var_value}
                  var_prefix="${var_value:0:3}"
                  echo "âœ… $var_name: å·²å†™å…¥ (é•¿åº¦: $var_length, å‰ç¼€: ${var_prefix}***)"
                fi
              else
                echo "âŒ $var_name: æœªæ‰¾åˆ°"
                MISSING_IN_FILE+=("$var_name")
              fi
            done

            echo "=========================================="
            if [ ${#MISSING_IN_FILE[@]} -gt 0 ]; then
              echo "âŒ .env æ–‡ä»¶ä¸­ç¼ºå¤±æˆ–ä¸ºç©ºçš„å˜é‡:"
              printf '   - %s\n' "${MISSING_IN_FILE[@]}"
              echo ""
              echo "ğŸ“„ .env æ–‡ä»¶å†…å®¹é¢„è§ˆï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰:"
              sed 's/\(=\).*/\1***/' "$ENV_FILE"
              exit 1
            else
              echo "âœ… .env æ–‡ä»¶æ‰€æœ‰å˜é‡éªŒè¯é€šè¿‡"
            fi
            echo "=========================================="
            echo ""

            # æ£€æŸ¥ PM2 æ˜¯å¦å®‰è£…
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¥ å®‰è£… PM2..."
              npm install -g pm2

              # è®¾ç½® PM2 å¼€æœºè‡ªå¯ï¼ˆä»…é¦–æ¬¡ï¼‰
              pm2 startup || true
            fi

            # ğŸ”¥ å¼ºåˆ¶åˆ é™¤æ—§è¿›ç¨‹å¹¶é‡æ–°å¯åŠ¨ï¼ˆç¡®ä¿ä½¿ç”¨æ–°é…ç½®ï¼‰
            echo "ğŸ”„ æ›´æ–° PM2 åº”ç”¨é…ç½®..."
            if pm2 list | grep -q "rungame-admin"; then
              echo "âš ï¸  æ£€æµ‹åˆ°æ—§è¿›ç¨‹ï¼Œå®Œå…¨åˆ é™¤å¹¶é‡æ–°åˆ›å»º..."

              # åˆ é™¤æ—§è¿›ç¨‹ï¼ˆç¡®ä¿æ—§é…ç½®ä¸æ®‹ç•™ï¼‰
              pm2 delete rungame-admin || true

              # ç­‰å¾…è¿›ç¨‹å®Œå…¨åœæ­¢
              sleep 2

              echo "âœ… æ—§è¿›ç¨‹å·²åˆ é™¤"
            fi

            # ä½¿ç”¨æ–°é…ç½®å¯åŠ¨
            echo "ğŸš€ ä½¿ç”¨æœ€æ–°é…ç½®å¯åŠ¨åº”ç”¨..."
            pm2 start ecosystem.config.js --only rungame-admin

            # ä¿å­˜ PM2 é…ç½®
            pm2 save

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 8

            # å¥åº·æ£€æŸ¥
            echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            for i in {1..15}; do
              if curl -f http://localhost:4000/api/health > /dev/null 2>&1; then
                echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
                break
              fi
              if [ $i -eq 15 ]; then
                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
                pm2 logs rungame-admin --lines 30 --nostream
                exit 1
              fi
              echo "ç­‰å¾…æœåŠ¡å°±ç»ª... ($i/15)"
              sleep 2
            done

            # æ˜¾ç¤º PM2 çŠ¶æ€
            echo "ğŸ“Š PM2 è¿›ç¨‹çŠ¶æ€:"
            pm2 list

            # æ˜¾ç¤ºå†…å­˜ä½¿ç”¨
            echo "ğŸ’¾ å†…å­˜ä½¿ç”¨æƒ…å†µ:"
            pm2 describe rungame-admin | grep -E "(memory|cpu)" || true

            echo "=========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸŒ è®¿é—®åœ°å€: ${NEXTAUTH_URL}"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

      # ==========================================
      # 10. éƒ¨ç½²æˆåŠŸé€šçŸ¥
      # ==========================================
      - name: âœ… Deployment Success
        if: success()
        run: |
          echo "=========================================="
          echo "âœ… PM2 éƒ¨ç½²æˆåŠŸï¼"
          echo "åº”ç”¨: RunGame Admin"
          echo "æ¨¡å¼: PM2 (è‡ªåŠ¨éƒ¨ç½²)"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "=========================================="

      # ==========================================
      # 11. éƒ¨ç½²å¤±è´¥é€šçŸ¥
      # ==========================================
      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "=========================================="
          echo "âŒ PM2 éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—"
          echo "=========================================="

      # ==========================================
      # 12. æ¢å¤åŸå§‹ Schemaï¼ˆæ¸…ç†ï¼‰
      # ==========================================
      - name: ğŸ”„ Restore Original Schemas
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        run: |
          echo "=========================================="
          echo "ğŸ”„ æ¢å¤åŸå§‹ Schema æ–‡ä»¶"
          echo "=========================================="

          if [ -f packages/database/prisma/schema.prisma.backup ]; then
            mv packages/database/prisma/schema.prisma.backup packages/database/prisma/schema.prisma
            echo "âœ… å·²æ¢å¤ schema.prisma"
          else
            echo "â„¹ï¸  æœªæ‰¾åˆ° schema.prisma å¤‡ä»½æ–‡ä»¶ï¼ˆå¯èƒ½æœªæ‰§è¡Œä¼˜åŒ–æ­¥éª¤ï¼‰"
          fi

          if [ -f packages/database/prisma/schema-admin.prisma.backup ]; then
            mv packages/database/prisma/schema-admin.prisma.backup packages/database/prisma/schema-admin.prisma
            echo "âœ… å·²æ¢å¤ schema-admin.prisma"
          else
            echo "â„¹ï¸  æœªæ‰¾åˆ° schema-admin.prisma å¤‡ä»½æ–‡ä»¶ï¼ˆå¯èƒ½æœªæ‰§è¡Œä¼˜åŒ–æ­¥éª¤ï¼‰"
          fi

          echo "=========================================="
          echo "âœ… æ¸…ç†å®Œæˆ"
          echo "=========================================="
