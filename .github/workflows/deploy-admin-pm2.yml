name: Deploy Admin to VPS (PM2 - Auto)

on:
  push:
    branches:
      - main                        # ä¸»åˆ†æ”¯è‡ªåŠ¨è§¦å‘
    paths:
      - 'apps/admin/**'
      - 'packages/database/**'
      - 'packages/typescript-config/**'
      - 'packages/tailwind-config/**'
      - 'pnpm-lock.yaml'
      - 'package.json'
      - 'turbo.json'
      - 'ecosystem.config.js'
      - '.github/workflows/deploy-admin-pm2.yml'

  workflow_dispatch:  # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      branch:
        description: 'è¦éƒ¨ç½²çš„åˆ†æ”¯ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨å½“å‰åˆ†æ”¯ï¼‰'
        required: false
        default: ''

jobs:
  build-and-deploy:
    name: Build on GitHub and Deploy via PM2
    runs-on: ubuntu-22.04  # ä½¿ç”¨ Ubuntu 22.04 (ä¸å¤§å¤šæ•° VPS ä¸€è‡´)

    steps:
      # ==========================================
      # 1. æ£€å‡ºä»£ç 
      # ==========================================
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      # ==========================================
      # 2. å®‰è£… pnpmï¼ˆå¿…é¡»åœ¨ setup-node ä¹‹å‰ï¼‰
      # ==========================================
      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v3
        # è‡ªåŠ¨è¯»å– package.json ä¸­çš„ packageManager å­—æ®µï¼ˆpnpm@9.15.4ï¼‰

      # ==========================================
      # 3. è®¾ç½® Node.js ç¯å¢ƒ
      # ==========================================
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # ==========================================
      # 4. å®‰è£…ä¾èµ–
      # ==========================================
      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      # ==========================================
      # 5. ç”Ÿæˆå¤šå¹³å° Prisma Client
      # ==========================================
      - name: ğŸ”§ Generate Prisma Client (multi-platform)
        run: |
          echo "ç”Ÿæˆæ”¯æŒå¤šå¹³å°çš„ Prisma Client..."
          echo "ğŸ“‹ Schema å·²é…ç½® binaryTargets: native, debian, rhel, alpine"

          # ç”Ÿæˆ Prisma Client åˆ°è‡ªå®šä¹‰è·¯å¾„ï¼ˆsrc/generated/ï¼‰
          pnpm db:generate

          # éªŒè¯ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶
          echo "âœ… å·²ç”Ÿæˆä»¥ä¸‹å¹³å°çš„ Prisma Client:"
          ls -lh packages/database/src/generated/client/ | grep -E "\.(so|node)" || true
          ls -lh packages/database/src/generated/prisma-admin/ | grep -E "\.(so|node)" || true

      # ==========================================
      # 6. æ„å»ºåº”ç”¨
      # ==========================================
      - name: ğŸ”¨ Build applications
        run: |
          echo "å¼€å§‹æ„å»º Admin åº”ç”¨..."
          pnpm build:admin

          echo "âœ… æ„å»ºå®Œæˆï¼Œæ£€æŸ¥äº§ç‰©:"
          ls -la apps/admin/.next
          echo "äº§ç‰©å¤§å°: $(du -sh apps/admin/.next | cut -f1)"

          # å¤åˆ¶é™æ€èµ„æºåˆ° standalone ç›®å½•ï¼ˆNext.js Standalone æ¨¡å¼å¿…éœ€ï¼‰
          echo "ğŸ“‹ å¤åˆ¶é™æ€èµ„æºåˆ° standalone ç›®å½•..."
          cp -r apps/admin/public apps/admin/.next/standalone/apps/admin/
          cp -r apps/admin/.next/static apps/admin/.next/standalone/apps/admin/.next/

          echo "âœ… Standalone ç›®å½•å‡†å¤‡å®Œæˆ:"
          ls -la apps/admin/.next/standalone/apps/admin/
          echo "Standalone å¤§å°: $(du -sh apps/admin/.next/standalone | cut -f1)"

      # ==========================================
      # 7. æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶ï¼ˆStandalone æ¨¡å¼ï¼‰
      # ==========================================
      - name: ğŸ“¦ Package build artifacts
        run: |
          echo "æ‰“åŒ… Standalone éƒ¨ç½²æ–‡ä»¶..."

          # åˆ›å»ºæ—¥å¿—ç›®å½•ç»“æ„ï¼ˆé¿å… PM2 å¯åŠ¨æ—¶æŠ¥é”™ï¼‰
          mkdir -p logs

          # æ‰“åŒ… standalone ç›®å½•ï¼ˆå·²åŒ…å«æœ€å°åŒ–çš„ node_modules å’Œæ‰€æœ‰å¿…éœ€æ–‡ä»¶ï¼‰
          tar -czf rungame-pm2-admin.tar.gz \
            --exclude='*.log' \
            apps/admin/.next/standalone \
            ecosystem.config.js \
            logs

          echo "âœ… æ‰“åŒ…å®Œæˆ"
          echo "ğŸ“Š å‹ç¼©åŒ…å¤§å°: $(du -h rungame-pm2-admin.tar.gz | cut -f1)"

          # æ˜¾ç¤ºæ‰“åŒ…å†…å®¹
          echo "ğŸ“‹ æ‰“åŒ…å†…å®¹:"
          tar -tzf rungame-pm2-admin.tar.gz | head -20

      # ==========================================
      # 8. ä¼ è¾“åˆ° VPS
      # ==========================================
      - name: ğŸšš Transfer to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "rungame-pm2-admin.tar.gz"
          target: "/tmp/"
          timeout: 10m

      # ==========================================
      # 9. éƒ¨ç½²åˆ° VPS
      # ==========================================
      - name: ğŸš€ Deploy on VPS via PM2
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CACHE_DATABASE_URL: ${{ secrets.CACHE_DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          envs: DATABASE_URL,CACHE_DATABASE_URL,NEXTAUTH_SECRET,NEXTAUTH_URL,ENCRYPTION_KEY,R2_ACCOUNT_ID,R2_ACCESS_KEY_ID,R2_SECRET_ACCESS_KEY,R2_BUCKET_NAME,R2_PUBLIC_URL
          command_timeout: 30m
          script: |
            set -e

            echo "=========================================="
            echo "ğŸš€ RunGame Admin Standalone éƒ¨ç½²å¼€å§‹"
            echo "æ¨¡å¼: Next.js Standalone (æ— éœ€ä¾èµ–å®‰è£…)"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

            # éƒ¨ç½²ç›®å½•
            DEPLOY_DIR="/www/wwwroot/rungame"

            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p $DEPLOY_DIR
            cd $DEPLOY_DIR

            # è§£å‹æ–°æ„å»ºï¼ˆStandalone åŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
            echo "ğŸ“¦ è§£å‹ Standalone æ„å»ºäº§ç‰©..."
            tar -xzf /tmp/rungame-pm2-admin.tar.gz
            rm -f /tmp/rungame-pm2-admin.tar.gz

            # éªŒè¯ Standalone ç›®å½•ç»“æ„
            echo "ğŸ” éªŒè¯ Standalone ç›®å½•..."
            if [ -f "apps/admin/.next/standalone/apps/admin/server.js" ]; then
              echo "âœ… Standalone server.js å­˜åœ¨"
            else
              echo "âŒ é”™è¯¯: server.js ä¸å­˜åœ¨"
              ls -la apps/admin/.next/standalone/apps/admin/ || true
              exit 1
            fi

            # éªŒè¯é™æ€èµ„æº
            if [ -d "apps/admin/.next/standalone/apps/admin/public" ] && [ -d "apps/admin/.next/standalone/apps/admin/.next/static" ]; then
              echo "âœ… é™æ€èµ„æºå·²å¤åˆ¶ï¼ˆpublic + .next/staticï¼‰"
            else
              echo "âš ï¸  è­¦å‘Š: é™æ€èµ„æºå¯èƒ½ç¼ºå¤±"
            fi

            # é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå†™å…¥ standalone ç›®å½•ï¼‰
            echo "âš™ï¸  é…ç½®ç¯å¢ƒå˜é‡..."
            cat > apps/admin/.next/standalone/apps/admin/.env << EOF
            # æ•°æ®åº“é…ç½®
            DATABASE_URL="${DATABASE_URL}"
            CACHE_DATABASE_URL="${CACHE_DATABASE_URL}"

            # NextAuth é…ç½®
            NEXTAUTH_SECRET="${NEXTAUTH_SECRET}"
            NEXTAUTH_URL="${NEXTAUTH_URL}"
            NEXTAUTH_TRUST_HOST=true

            # åŠ å¯†å¯†é’¥
            ENCRYPTION_KEY="${ENCRYPTION_KEY}"

            # R2 å­˜å‚¨é…ç½®
            R2_ACCOUNT_ID="${R2_ACCOUNT_ID}"
            R2_ACCESS_KEY_ID="${R2_ACCESS_KEY_ID}"
            R2_SECRET_ACCESS_KEY="${R2_SECRET_ACCESS_KEY}"
            R2_BUCKET_NAME="${R2_BUCKET_NAME}"
            R2_PUBLIC_URL="${R2_PUBLIC_URL}"

            # è¿è¡Œç¯å¢ƒ
            NODE_ENV=production
            PORT=4000
            HOSTNAME=0.0.0.0
            EOF

            echo "âœ… ç¯å¢ƒå˜é‡å·²é…ç½®ï¼ˆstandalone ç›®å½•ï¼‰"

            # æ£€æŸ¥ PM2 æ˜¯å¦å®‰è£…
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¥ å®‰è£… PM2..."
              npm install -g pm2

              # è®¾ç½® PM2 å¼€æœºè‡ªå¯ï¼ˆä»…é¦–æ¬¡ï¼‰
              pm2 startup || true
            fi

            # é‡å¯ PM2 åº”ç”¨
            echo "ğŸ”„ é‡å¯ PM2 åº”ç”¨..."
            if pm2 list | grep -q "rungame-admin"; then
              # åº”ç”¨å·²å­˜åœ¨ï¼Œé‡å¯
              pm2 restart ecosystem.config.js --only rungame-admin --update-env
            else
              # é¦–æ¬¡éƒ¨ç½²ï¼Œå¯åŠ¨
              pm2 start ecosystem.config.js --only rungame-admin
            fi

            # ä¿å­˜ PM2 é…ç½®
            pm2 save

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 8

            # å¥åº·æ£€æŸ¥
            echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            for i in {1..15}; do
              if curl -f http://localhost:4000/api/health > /dev/null 2>&1; then
                echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
                break
              fi
              if [ $i -eq 15 ]; then
                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
                pm2 logs rungame-admin --lines 30 --nostream
                exit 1
              fi
              echo "ç­‰å¾…æœåŠ¡å°±ç»ª... ($i/15)"
              sleep 2
            done

            # æ˜¾ç¤º PM2 çŠ¶æ€
            echo "ğŸ“Š PM2 è¿›ç¨‹çŠ¶æ€:"
            pm2 list

            # æ˜¾ç¤ºå†…å­˜ä½¿ç”¨
            echo "ğŸ’¾ å†…å­˜ä½¿ç”¨æƒ…å†µ:"
            pm2 describe rungame-admin | grep -E "(memory|cpu)" || true

            echo "=========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸŒ è®¿é—®åœ°å€: ${NEXTAUTH_URL}"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

      # ==========================================
      # 10. éƒ¨ç½²æˆåŠŸé€šçŸ¥
      # ==========================================
      - name: âœ… Deployment Success
        if: success()
        run: |
          echo "=========================================="
          echo "âœ… PM2 éƒ¨ç½²æˆåŠŸï¼"
          echo "åº”ç”¨: RunGame Admin"
          echo "æ¨¡å¼: PM2 (è‡ªåŠ¨éƒ¨ç½²)"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "=========================================="

      # ==========================================
      # 11. éƒ¨ç½²å¤±è´¥é€šçŸ¥
      # ==========================================
      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "=========================================="
          echo "âŒ PM2 éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—"
          echo "=========================================="
