name: Deploy Admin to VPS

on:
  push:
    branches:
      - main                        # ä»…ä¸»åˆ†æ”¯è§¦å‘è‡ªåŠ¨éƒ¨ç½²
    paths:
      - 'apps/admin/**'
      - 'packages/database/**'
      - 'Dockerfile.admin'
      - 'docker-compose.admin.yml'
      - '.github/workflows/deploy-admin.yml'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      branch:
        description: 'è¦éƒ¨ç½²çš„åˆ†æ”¯ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨å½“å‰åˆ†æ”¯ï¼‰'
        required: false
        default: ''
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: false
        type: choice
        default: 'production'
        options:
          - production
          - staging
          - development

jobs:
  deploy:
    name: Deploy to VPS via SSH
    runs-on: ubuntu-latest

    steps:
      # ==========================================
      # 1. æ£€å‡ºä»£ç 
      # ==========================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      # ==========================================
      # 2. è®¾ç½® Node.js ç¯å¢ƒï¼ˆå¯é€‰ï¼Œç”¨äºæ„å»ºæ£€æŸ¥ï¼‰
      # ==========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ==========================================
      # 3. è·å–åˆ†æ”¯ä¿¡æ¯
      # ==========================================
      - name: Get branch info
        id: branch
        run: |
          # è·å–åˆ†æ”¯åç§°ï¼ˆå»æ‰ refs/heads/ å‰ç¼€ï¼‰
          BRANCH_NAME="${{ github.event.inputs.branch || github.ref_name }}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "éƒ¨ç½²åˆ†æ”¯: ${BRANCH_NAME}"
          echo "éƒ¨ç½²ç¯å¢ƒ: ${{ github.event.inputs.environment || 'production' }}"

      # ==========================================
      # 4. SSH éƒ¨ç½²åˆ° VPS
      # ==========================================
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_BRANCH: ${{ steps.branch.outputs.branch_name }}
          DEPLOY_ENV: ${{ github.event.inputs.environment || 'production' }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          envs: DEPLOY_BRANCH,DEPLOY_ENV
          script: |
            # è®¾ç½®é”™è¯¯æ—¶é€€å‡º
            set -e

            echo "=========================================="
            echo "å¼€å§‹éƒ¨ç½² RunGame ç®¡ç†ç«¯"
            echo "åˆ†æ”¯: ${DEPLOY_BRANCH}"
            echo "ç¯å¢ƒ: ${DEPLOY_ENV}"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/1panel/docker/compose/rungame-admin || {
              echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆåœ¨ 1Panel ä¸­åˆ›å»ºé¡¹ç›®"
              exit 1
            }

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¦ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin

            # åˆ‡æ¢åˆ°æŒ‡å®šåˆ†æ”¯
            echo "ğŸ”€ åˆ‡æ¢åˆ°åˆ†æ”¯: ${DEPLOY_BRANCH}"
            git checkout ${DEPLOY_BRANCH}
            git reset --hard origin/${DEPLOY_BRANCH}

            # å¤‡ä»½å½“å‰å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if docker ps -a --format '{{.Names}}' | grep -q "^rungame-admin$"; then
              echo "ğŸ’¾ å¤‡ä»½å½“å‰å®¹å™¨..."
              docker commit rungame-admin rungame-admin:backup-$(date +%Y%m%d_%H%M%S) || true
            fi

            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker-compose -f docker-compose.admin.yml down || true

            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
            docker image prune -f || true

            # æ„å»ºæ–°é•œåƒ
            echo "ğŸ”¨ æ„å»ºæ–°é•œåƒ..."
            docker-compose -f docker-compose.admin.yml build --no-cache

            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker-compose -f docker-compose.admin.yml up -d

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15

            # å¥åº·æ£€æŸ¥
            echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            for i in {1..30}; do
              if curl -f http://localhost:4000/api/health > /dev/null 2>&1; then
                echo "âœ… æœåŠ¡å·²å°±ç»ªï¼"
                break
              fi
              echo "ç­‰å¾…æœåŠ¡å°±ç»ª... ($i/30)"
              sleep 2
            done

            # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€
            echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
            docker ps --filter name=rungame-admin

            echo "=========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="

      # ==========================================
      # 5. éƒ¨ç½²ç»“æœé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      # ==========================================
      - name: Send notification on success
        if: success()
        run: |
          echo "âœ… ç®¡ç†ç«¯éƒ¨ç½²æˆåŠŸ"
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œå¦‚å‘é€é‚®ä»¶ã€Slackã€é’‰é’‰ç­‰

      - name: Send notification on failure
        if: failure()
        run: |
          echo "âŒ ç®¡ç†ç«¯éƒ¨ç½²å¤±è´¥"
          # è¿™é‡Œå¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥é€»è¾‘
