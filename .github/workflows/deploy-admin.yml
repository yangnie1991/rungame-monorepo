name: Deploy Admin to VPS

on:
  push:
    branches:
      - main                        # ä»…ä¸»åˆ†æ”¯è§¦å‘è‡ªåŠ¨éƒ¨ç½²
    paths:
      - 'apps/admin/**'
      - 'packages/database/**'
      - 'Dockerfile.admin'
      - 'docker-compose.admin.yml'
      - '.github/workflows/deploy-admin.yml'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      branch:
        description: 'è¦éƒ¨ç½²çš„åˆ†æ”¯ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨å½“å‰åˆ†æ”¯ï¼‰'
        required: false
        default: ''
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: false
        type: choice
        default: 'production'
        options:
          - production
          - staging
          - development

jobs:
  deploy:
    name: Deploy to VPS via SSH
    runs-on: ubuntu-latest

    steps:
      # ==========================================
      # 1. æ£€å‡ºä»£ç 
      # ==========================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      # ==========================================
      # 2. è®¾ç½® Node.js ç¯å¢ƒï¼ˆå¯é€‰ï¼Œç”¨äºæ„å»ºæ£€æŸ¥ï¼‰
      # ==========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ==========================================
      # 3. è·å–åˆ†æ”¯ä¿¡æ¯
      # ==========================================
      - name: Get branch info
        id: branch
        run: |
          # è·å–åˆ†æ”¯åç§°ï¼ˆå»æ‰ refs/heads/ å‰ç¼€ï¼‰
          BRANCH_NAME="${{ github.event.inputs.branch || github.ref_name }}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "éƒ¨ç½²åˆ†æ”¯: ${BRANCH_NAME}"
          echo "éƒ¨ç½²ç¯å¢ƒ: ${{ github.event.inputs.environment || 'production' }}"

      # ==========================================
      # 4. SSH éƒ¨ç½²åˆ° VPS
      # ==========================================
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_BRANCH: ${{ steps.branch.outputs.branch_name }}
          DEPLOY_ENV: ${{ github.event.inputs.environment || 'production' }}
          # ç¯å¢ƒå˜é‡ï¼ˆä» GitHub Secrets ä¼ é€’ï¼‰
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CACHE_DATABASE_URL: ${{ secrets.CACHE_DATABASE_URL }}
          CACHE_DB_PASSWORD: ${{ secrets.CACHE_DB_PASSWORD }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          envs: DEPLOY_BRANCH,DEPLOY_ENV,DATABASE_URL,CACHE_DATABASE_URL,CACHE_DB_PASSWORD,NEXTAUTH_SECRET,NEXTAUTH_URL,R2_ACCOUNT_ID,R2_ACCESS_KEY_ID,R2_SECRET_ACCESS_KEY,R2_BUCKET_NAME,R2_PUBLIC_URL
          script: |
            # è®¾ç½®é”™è¯¯æ—¶é€€å‡º
            set -e

            echo "=========================================="
            echo "å¼€å§‹éƒ¨ç½² RunGame ç®¡ç†ç«¯"
            echo "åˆ†æ”¯: ${DEPLOY_BRANCH}"
            echo "ç¯å¢ƒ: ${DEPLOY_ENV}"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="

            # æ£€æŸ¥å¹¶åˆå§‹åŒ–é¡¹ç›®ç›®å½•
            if [ ! -d "/opt/1panel/docker/compose/rungame-admin" ]; then
              echo "ğŸ“ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¹¶å…‹éš†ä»“åº“..."
              mkdir -p /opt/1panel/docker/compose
              cd /opt/1panel/docker/compose
              git clone https://github.com/${GITHUB_REPOSITORY}.git rungame-admin
              cd rungame-admin
            else
              # è¿›å…¥å·²å­˜åœ¨çš„é¡¹ç›®ç›®å½•
              cd /opt/1panel/docker/compose/rungame-admin

              # æ£€æŸ¥æ˜¯å¦ä¸º Git ä»“åº“
              if [ ! -d .git ]; then
                echo "âš ï¸  ç›®å½•å­˜åœ¨ä½†ä¸æ˜¯ Git ä»“åº“ï¼Œé‡æ–°åˆå§‹åŒ–..."
                cd ..
                mv rungame-admin rungame-admin.backup.$(date +%Y%m%d_%H%M%S)
                git clone https://github.com/${GITHUB_REPOSITORY}.git rungame-admin
                cd rungame-admin
              else
                # æ‹‰å–æœ€æ–°ä»£ç 
                echo "ğŸ“¦ æ‹‰å–æœ€æ–°ä»£ç ..."
                git fetch origin
              fi
            fi

            # åˆ‡æ¢åˆ°æŒ‡å®šåˆ†æ”¯
            echo "ğŸ”€ åˆ‡æ¢åˆ°åˆ†æ”¯: ${DEPLOY_BRANCH}"
            git checkout ${DEPLOY_BRANCH}
            git reset --hard origin/${DEPLOY_BRANCH}

            # ç”Ÿæˆ .env æ–‡ä»¶ï¼ˆä» GitHub Secretsï¼‰
            echo "ğŸ“ ç”Ÿæˆ .env é…ç½®æ–‡ä»¶..."
            cat > .env <<EOF
            # ä¸»æ•°æ®åº“é…ç½®ï¼ˆä¸šåŠ¡æ•°æ®ï¼‰
            DATABASE_URL=${DATABASE_URL}

            # ç¼“å­˜æ•°æ®åº“é…ç½®ï¼ˆGamePix ç¼“å­˜ + AI å¯¹è¯å†å²ï¼‰
            CACHE_DATABASE_URL=${CACHE_DATABASE_URL:-}
            CACHE_DB_PASSWORD=${CACHE_DB_PASSWORD:-}

            # NextAuth é…ç½®
            NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
            NEXTAUTH_URL=${NEXTAUTH_URL}

            # R2 å­˜å‚¨é…ç½®
            R2_ACCOUNT_ID=${R2_ACCOUNT_ID:-}
            R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID:-}
            R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY:-}
            R2_BUCKET_NAME=${R2_BUCKET_NAME:-}
            R2_PUBLIC_URL=${R2_PUBLIC_URL:-}
            EOF
            echo "âœ… .env æ–‡ä»¶å·²ç”Ÿæˆ"

            # å¤‡ä»½å½“å‰å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if docker ps -a --format '{{.Names}}' | grep -q "^rungame-admin$"; then
              echo "ğŸ’¾ å¤‡ä»½å½“å‰å®¹å™¨..."
              docker commit rungame-admin rungame-admin:backup-$(date +%Y%m%d_%H%M%S) || true
            fi

            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker-compose -f docker-compose.admin.yml down || true

            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
            docker image prune -f || true

            # æ„å»ºæ–°é•œåƒï¼ˆåˆ©ç”¨ Docker å±‚ç¼“å­˜ï¼ŒåŠ å¿«æ„å»ºé€Ÿåº¦ï¼‰
            echo "ğŸ”¨ æ„å»ºæ–°é•œåƒ..."
            docker-compose -f docker-compose.admin.yml build

            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker-compose -f docker-compose.admin.yml up -d

            # ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆstandalone æ¨¡å¼å¯åŠ¨é€Ÿåº¦æå‡ 50%ï¼‰
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 8

            # å¥åº·æ£€æŸ¥ï¼ˆå¯¹é½ Dockerfile HEALTHCHECK çš„ start-period=40sï¼‰
            echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            for i in {1..20}; do
              if curl -f http://localhost:3001/api/health > /dev/null 2>&1; then
                echo "âœ… æœåŠ¡å·²å°±ç»ªï¼"
                break
              fi
              echo "ç­‰å¾…æœåŠ¡å°±ç»ª... ($i/20)"
              sleep 2
            done

            # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€
            echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
            docker ps --filter name=rungame-admin

            echo "=========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="

      # ==========================================
      # 4. éƒ¨ç½²ç»“æœé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      # ==========================================
      - name: Send notification on success
        if: success()
        run: |
          echo "âœ… ç®¡ç†ç«¯éƒ¨ç½²æˆåŠŸ"
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œå¦‚å‘é€é‚®ä»¶ã€Slackã€é’‰é’‰ç­‰

      - name: Send notification on failure
        if: failure()
        run: |
          echo "âŒ ç®¡ç†ç«¯éƒ¨ç½²å¤±è´¥"
          # è¿™é‡Œå¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥é€»è¾‘
