# RunGame Admin - ä¼˜åŒ–çš„å¤šé˜¶æ®µ Docker æ„å»º
# åŸºäº Next.js å®˜æ–¹æœ€ä½³å®è·µ + Monorepo æ¶æ„

# ============================================
# ç¬¬ä¸€é˜¶æ®µ: åŸºç¡€é•œåƒ
# ============================================
FROM node:20-alpine AS base
WORKDIR /app

# ============================================
# ç¬¬äºŒé˜¶æ®µ: ä¾èµ–å®‰è£…
# ============================================
FROM base AS deps

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache libc6-compat

# å®‰è£… pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# å¤åˆ¶ package æ–‡ä»¶å’Œ pnpm é…ç½®
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/admin/package.json ./apps/admin/
COPY packages/database/package.json ./packages/database/

# å®‰è£…ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependenciesï¼Œæ„å»ºæ—¶éœ€è¦ï¼‰
RUN pnpm install --frozen-lockfile

# ============================================
# ç¬¬ä¸‰é˜¶æ®µ: æ„å»ºåº”ç”¨
# ============================================
FROM base AS builder

# å®‰è£… pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# å¤åˆ¶ä¾èµ–ï¼ˆpnpm ä¼šè‡ªåŠ¨å¤„ç† workspace ä¾èµ–ï¼‰
COPY --from=deps /app/node_modules ./node_modules

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºå‚æ•°ï¼ˆå¯åœ¨æ„å»ºæ—¶ä¼ å…¥ï¼‰
ARG DATABASE_URL
ARG NEXTAUTH_SECRET
ARG NEXTAUTH_URL
ARG NODE_ENV=production

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DATABASE_URL=${DATABASE_URL}
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ENV NODE_ENV=${NODE_ENV}
ENV NEXT_TELEMETRY_DISABLED=1

# ç”Ÿæˆ Prisma Client
RUN pnpm db:generate

# æ„å»º admin åº”ç”¨ï¼ˆä½¿ç”¨ Turbopackï¼Œç”Ÿæˆ standalone è¾“å‡ºï¼‰
RUN pnpm build:admin

# ============================================
# ç¬¬å››é˜¶æ®µ: ç”Ÿäº§è¿è¡Œæ—¶ï¼ˆStandalone ä¼˜åŒ–ï¼‰
# ============================================
FROM base AS runner

# åˆ›å»ºé root ç”¨æˆ·ï¼ˆå®‰å…¨æ€§æœ€ä½³å®è·µï¼‰
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–ï¼ˆä»… curl ç”¨äºå¥åº·æ£€æŸ¥ï¼‰
RUN apk add --no-cache curl

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=4000
ENV HOSTNAME="0.0.0.0"

# ğŸ”¥ å…³é”®ä¼˜åŒ–ï¼šå¤åˆ¶ standalone è¾“å‡ºï¼ˆè€Œéå®Œæ•´ node_modulesï¼‰
# Next.js standalone æ¨¡å¼ä¼šè‡ªåŠ¨ç”Ÿæˆæœ€å°åŒ–çš„ä¾èµ–æ ‘
COPY --from=builder --chown=nextjs:nodejs /app/apps/admin/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/admin/.next/static ./apps/admin/.next/static
COPY --from=builder --chown=nextjs:nodejs /app/apps/admin/public ./apps/admin/public

# Monorepo ç‰¹æ®Šéœ€æ±‚ï¼šå¤åˆ¶æ•°æ®åº“åŒ…ï¼ˆPrisma Clientï¼‰
COPY --from=builder --chown=nextjs:nodejs /app/packages/database ./packages/database

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nextjs

# æš´éœ²ç«¯å£
EXPOSE 4000

# å¥åº·æ£€æŸ¥ï¼ˆæ¯”å®˜æ–¹ç¤ºä¾‹æ›´å®Œå–„ï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:4000/api/health || exit 1

# ğŸ”¥ ä½¿ç”¨ standalone ç”Ÿæˆçš„ server.jsï¼ˆæ€§èƒ½æå‡ 50%+ï¼‰
CMD ["node", "apps/admin/server.js"]
