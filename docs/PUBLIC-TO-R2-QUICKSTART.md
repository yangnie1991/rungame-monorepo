# Public æ–‡ä»¶å¤¹è¿ç§»åˆ° R2 å¿«é€Ÿå¼€å§‹æŒ‡å—

æœ¬æ–‡æ¡£æä¾›å°† `public` æ–‡ä»¶å¤¹é™æ€æ–‡ä»¶è¿ç§»åˆ° Cloudflare R2 çš„å¿«é€Ÿå¼€å§‹æ­¥éª¤ã€‚

---

## ğŸ¯ å¿«é€Ÿå†³ç­–ï¼šé€‰æ‹©å“ªä¸ªæ–¹æ¡ˆï¼Ÿ

### æ–¹æ¡ˆå¯¹æ¯”è¡¨

| æ–¹æ¡ˆ | å®æ–½æ—¶é—´ | ç»´æŠ¤æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|-----|---------|---------|---------|
| **æ–¹æ¡ˆ 1: æ··åˆæ–¹æ¡ˆ** | 0 åˆ†é’Ÿ | æ—  | æ¨èå¤§å¤šæ•°æƒ…å†µ |
| **æ–¹æ¡ˆ 2: Rewrites ä»£ç†** | 30 åˆ†é’Ÿ | ä½ | éœ€è¦ç»Ÿä¸€ç®¡ç†èµ„æº |
| **æ–¹æ¡ˆ 3: Worker è¾¹ç¼˜** | 2 å°æ—¶ | ä¸­ | å…¨çƒåŒ–é«˜å¹¶å‘åœºæ™¯ |

### æ¨èå»ºè®®

âœ… **ä¼˜å…ˆä½¿ç”¨æ–¹æ¡ˆ 1**ï¼ˆæ— éœ€ä»»ä½•ä¿®æ”¹ï¼‰ï¼š
- ä½ çš„ `ads.txt`ã€`robots.txt` ç­‰æ–‡ä»¶å¾ˆå°ï¼ˆ< 10KBï¼‰
- ä½ çš„é™æ€æ–‡ä»¶æ€»é‡ < 100MB
- ä½ æƒ³è¦æœ€ç®€å•å¯é çš„æ–¹æ¡ˆ

âœ… **è€ƒè™‘ä½¿ç”¨æ–¹æ¡ˆ 2**ï¼ˆéœ€è¦é…ç½®ï¼‰ï¼š
- ä½ æœ‰å¤§é‡é™æ€èµ„æºï¼ˆ> 100MBï¼‰
- ä½ å¸Œæœ›æ‰€æœ‰æ–‡ä»¶ç»Ÿä¸€ç”± CDN åŠ é€Ÿ
- ä½ æ„¿æ„èŠ± 30 åˆ†é’Ÿé…ç½®

âœ… **ä»…åœ¨ä»¥ä¸‹æƒ…å†µä½¿ç”¨æ–¹æ¡ˆ 3**ï¼š
- ä½ çš„é¡¹ç›®æ˜¯å…¨çƒåŒ–éƒ¨ç½²
- ä½ æœ‰å¤§é‡å¹¶å‘è®¿é—®ï¼ˆ> 10000 QPSï¼‰
- ä½ æœ‰ä¸“ä¸šçš„ DevOps å›¢é˜Ÿ

---

## ğŸš€ æ–¹æ¡ˆ 1: æ··åˆæ–¹æ¡ˆï¼ˆæ¨èï¼‰

### ä»€ä¹ˆéƒ½ä¸ç”¨åšï¼

ä½ å½“å‰çš„é…ç½®å·²ç»æ˜¯æœ€ä½³æ–¹æ¡ˆï¼š

```
public/
â”œâ”€â”€ ads.txt          âœ… ä¿ç•™ï¼ˆå¹¿å‘Šå¹³å°éªŒè¯å¿…éœ€ï¼‰
â”œâ”€â”€ robots.txt       âœ… ä¿ç•™ï¼ˆSEO å¿…éœ€ï¼‰
â”œâ”€â”€ llms.txt         âœ… ä¿ç•™ï¼ˆAI çˆ¬è™«æŒ‡å¼•ï¼‰
â”œâ”€â”€ sitemap.xml      âœ… ä¿ç•™ï¼ˆSEO å¿…éœ€ï¼‰
â”œâ”€â”€ *.txt            âœ… ä¿ç•™ï¼ˆå„ç±»éªŒè¯æ–‡ä»¶ï¼‰
â””â”€â”€ favicon.ico      âœ… ä¿ç•™ï¼ˆæµè§ˆå™¨ä¼˜åŒ–ï¼‰
```

### ä¸ºä»€ä¹ˆè¿™æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Ÿ

1. **Google AdSense è¦æ±‚**ï¼š`ads.txt` å¿…é¡»åœ¨æ ¹åŸŸåç›´æ¥è®¿é—®ï¼Œä¸èƒ½æœ‰ä»»ä½•ä»£ç†æˆ–é‡å®šå‘
2. **æ–‡ä»¶å¾ˆå°**ï¼šæ‰€æœ‰è¿™äº›æ–‡ä»¶åŠ èµ·æ¥ä¸åˆ° 1MBï¼Œå¯¹æœåŠ¡å™¨è´Ÿæ‹…å¯å¿½ç•¥
3. **é›¶ç»´æŠ¤æˆæœ¬**ï¼šä¸éœ€è¦é…ç½®ã€ä¸éœ€è¦è„šæœ¬ã€ä¸éœ€è¦æ‹…å¿ƒåŒæ­¥é—®é¢˜
4. **å¯é æ€§æœ€é«˜**ï¼šä¸ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œä¸ä¼šå‡ºç° R2 æ•…éšœå¯¼è‡´ ads.txt æ— æ³•è®¿é—®çš„æƒ…å†µ

### ç»“è®º

**âœ¨ å¯¹äº ads.txt è¿™ç±»æ ¹åŸŸåæ–‡ä»¶ï¼Œå¼ºçƒˆå»ºè®®ä¿ç•™åœ¨ public æ–‡ä»¶å¤¹ã€‚**

---

## ğŸ”„ æ–¹æ¡ˆ 2: Next.js Rewrites ä»£ç†ï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ åšæŒè¦å°†æ‰€æœ‰æ–‡ä»¶éƒ½æ”¾åˆ° R2ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

### æ­¥éª¤ 1: å®‰è£…ä¾èµ–

```bash
npm install glob mime-types
npm install -D @types/mime-types
```

### æ­¥éª¤ 2: ä¸Šä¼ æ–‡ä»¶åˆ° R2

```bash
# å¢é‡ä¸Šä¼ ï¼ˆæ¨èï¼‰
npx tsx scripts/sync-public-to-r2.ts

# å¼ºåˆ¶ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
npx tsx scripts/sync-public-to-r2.ts --force
```

### æ­¥éª¤ 3: é…ç½® Next.js Rewrites

ç¼–è¾‘ `next.config.ts`ï¼š

```typescript
const nextConfig: NextConfig = {
  // ... ç°æœ‰é…ç½®

  async rewrites() {
    const R2_PUBLIC_URL =
      process.env.R2_PUBLIC_URL ||
      `https://pub-${process.env.R2_ACCOUNT_ID}.r2.dev`

    return [
      // æ ¹åŸŸå .txt æ–‡ä»¶
      {
        source: "/ads.txt",
        destination: `${R2_PUBLIC_URL}/public/ads.txt`,
      },
      {
        source: "/llms.txt",
        destination: `${R2_PUBLIC_URL}/public/llms.txt`,
      },
      {
        source: "/robots.txt",
        destination: `${R2_PUBLIC_URL}/public/robots.txt`,
      },
      // åŒ¹é…æ‰€æœ‰éªŒè¯æ–‡ä»¶
      {
        source: "/:path*.txt",
        destination: `${R2_PUBLIC_URL}/public/:path*.txt`,
      },
      // å…¶ä»–æ–‡ä»¶
      {
        source: "/sitemap.xml",
        destination: `${R2_PUBLIC_URL}/public/sitemap.xml`,
      },
      {
        source: "/favicon.ico",
        destination: `${R2_PUBLIC_URL}/public/favicon.ico`,
      },
    ]
  },
}
```

### æ­¥éª¤ 4: æµ‹è¯•éªŒè¯

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# æµ‹è¯•æ–‡ä»¶æ˜¯å¦å¯è®¿é—®
curl http://localhost:3000/ads.txt
curl http://localhost:3000/llms.txt
curl http://localhost:3000/robots.txt
```

### æ­¥éª¤ 5: éªŒè¯ Google AdSense

è®¿é—® Google AdSense â†’ ç½‘ç«™ â†’ æ£€æŸ¥ ads.txt

ç¡®ä¿æ˜¾ç¤ºï¼š"âœ… ads.txt æ–‡ä»¶å¯è®¿é—®"

---

## ğŸ“Š ä¸Šä¼ è„šæœ¬ä½¿ç”¨æŒ‡å—

### åŸºæœ¬ç”¨æ³•

```bash
# æŸ¥çœ‹å¸®åŠ©
npx tsx scripts/sync-public-to-r2.ts --help

# å¢é‡ä¸Šä¼ ï¼ˆæ¨èï¼‰- ä»…ä¸Šä¼ æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶
npx tsx scripts/sync-public-to-r2.ts

# å¼ºåˆ¶ä¸Šä¼  - è¦†ç›–æ‰€æœ‰æ–‡ä»¶
npx tsx scripts/sync-public-to-r2.ts --force
```

### æ’é™¤ç‰¹å®šæ–‡ä»¶

ç¼–è¾‘ `scripts/sync-public-to-r2.ts`ï¼Œä¿®æ”¹ `excludePatterns`ï¼š

```typescript
const excludePatterns = [
  "ads.txt",        // æ’é™¤ ads.txt
  "robots.txt",     // æ’é™¤ robots.txt
  "llms.txt",       // æ’é™¤ llms.txt
  "sitemap.xml",    // æ’é™¤ sitemap.xml
  "*.txt",          // æ’é™¤æ‰€æœ‰ .txt æ–‡ä»¶
  "favicon.ico",    // æ’é™¤ favicon
]
```

### æ·»åŠ åˆ°éƒ¨ç½²æµç¨‹

ç¼–è¾‘ `package.json`ï¼š

```json
{
  "scripts": {
    "r2:sync": "tsx scripts/sync-public-to-r2.ts",
    "r2:sync:force": "tsx scripts/sync-public-to-r2.ts --force",
    "prebuild": "npm run r2:sync"
  }
}
```

è¿™æ ·æ¯æ¬¡ `npm run build` å‰ä¼šè‡ªåŠ¨åŒæ­¥æ–‡ä»¶åˆ° R2ã€‚

---

## ğŸ” éªŒè¯æ¸…å•

### 1. æ£€æŸ¥ ads.txt æ˜¯å¦å¯è®¿é—®

```bash
# æœ¬åœ°æµ‹è¯•
curl http://localhost:3000/ads.txt

# ç”Ÿäº§ç¯å¢ƒæµ‹è¯•
curl https://yourdomain.com/ads.txt
```

**é¢„æœŸç»“æœ**ï¼šåº”è¯¥è¿”å› ads.txt çš„å®Œæ•´å†…å®¹

### 2. æ£€æŸ¥ Google AdSense

1. ç™»å½• [Google AdSense](https://www.google.com/adsense/)
2. è¿›å…¥ **ç½‘ç«™** â†’ **ç½‘ç«™ç®¡ç†**
3. æŸ¥çœ‹ ads.txt çŠ¶æ€

**é¢„æœŸç»“æœ**ï¼šâœ… ads.txt æ–‡ä»¶å¯è®¿é—®

### 3. æ£€æŸ¥æœç´¢å¼•æ“çˆ¬è™«

```bash
curl -A "Googlebot" https://yourdomain.com/robots.txt
```

**é¢„æœŸç»“æœ**ï¼šè¿”å› robots.txt å†…å®¹

### 4. æ£€æŸ¥å“åº”æ—¶é—´

```bash
time curl -s -o /dev/null https://yourdomain.com/ads.txt
```

**é¢„æœŸç»“æœ**ï¼š
- ç›´æ¥è®¿é—®ï¼ˆæ–¹æ¡ˆ 1ï¼‰ï¼š< 100ms
- Rewrites ä»£ç†ï¼ˆæ–¹æ¡ˆ 2ï¼‰ï¼š< 300ms
- Worker è¾¹ç¼˜ï¼ˆæ–¹æ¡ˆ 3ï¼‰ï¼š< 50ms

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ Google AdSense æ˜¾ç¤º"ads.txt æ–‡ä»¶æ— æ³•è®¿é—®"ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
1. R2 bucket æœªå¯ç”¨å…¬å¼€è®¿é—®
2. rewrites é…ç½®é”™è¯¯
3. æ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®
4. CDN ç¼“å­˜æœªåˆ·æ–°

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨ R2
curl https://pub-{ACCOUNT_ID}.r2.dev/public/ads.txt

# 2. æ£€æŸ¥æœ¬åœ°æ˜¯å¦å¯è®¿é—®
curl http://localhost:3000/ads.txt

# 3. æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒ
curl https://yourdomain.com/ads.txt

# 4. æ¸…é™¤ Cloudflare ç¼“å­˜
# åœ¨ Cloudflare Dashboard â†’ ç¼“å­˜ â†’ æ¸…é™¤æ‰€æœ‰
```

### Q2: ä¸Šä¼ è„šæœ¬æŠ¥é”™"InvalidAccessKeyId"

**åŸå› **ï¼šR2 å‡­æ®é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ .env æ–‡ä»¶
cat .env | grep R2_

# ç¡®ä¿æ ¼å¼æ­£ç¡®ï¼ˆä¸è¦æœ‰å¤šä½™ç©ºæ ¼ï¼‰
R2_ACCOUNT_ID=abc123
R2_ACCESS_KEY_ID=def456
R2_SECRET_ACCESS_KEY=ghi789
R2_BUCKET_NAME=game-onilne
```

### Q3: ä½¿ç”¨ rewrites åï¼Œads.txt åŠ è½½å˜æ…¢äº†

**åŸå› **ï¼šæ¯æ¬¡è¯·æ±‚éƒ½è¦é€šè¿‡åº”ç”¨æœåŠ¡å™¨ä»£ç†åˆ° R2

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æ–¹æ¡ˆ A**ï¼šä½¿ç”¨æ–¹æ¡ˆ 1ï¼ˆæ··åˆæ–¹æ¡ˆï¼‰ï¼Œads.txt ä¿ç•™åœ¨ public
2. **æ–¹æ¡ˆ B**ï¼šå‡çº§åˆ°æ–¹æ¡ˆ 3ï¼ˆWorker è¾¹ç¼˜å¤„ç†ï¼‰
3. **æ–¹æ¡ˆ C**ï¼šåœ¨ Cloudflare æ·»åŠ  Page Rule ç¼“å­˜ï¼š
   ```
   URL: yourdomain.com/ads.txt
   Cache Level: Cache Everything
   Edge Cache TTL: 1 hour
   ```

### Q4: èƒ½å¦åªå°†å›¾ç‰‡ä¸Šä¼ åˆ° R2ï¼Œæ–‡æœ¬æ–‡ä»¶ä¿ç•™åœ¨ publicï¼Ÿ

**å¯ä»¥ï¼** è¿™æ­£æ˜¯æ¨èçš„æ··åˆæ–¹æ¡ˆã€‚

ä¿®æ”¹ä¸Šä¼ è„šæœ¬çš„ `excludePatterns`ï¼š

```typescript
const excludePatterns = [
  "*.txt",          // æ’é™¤æ‰€æœ‰æ–‡æœ¬æ–‡ä»¶
  "*.xml",          // æ’é™¤æ‰€æœ‰ XML æ–‡ä»¶
  "*.ico",          // æ’é™¤ favicon
]
```

è¿™æ ·åªä¼šä¸Šä¼ å›¾ç‰‡ã€å­—ä½“ã€è§†é¢‘ç­‰èµ„æºæ–‡ä»¶ã€‚

---

## ğŸ“ æœ€ä½³å®è·µæ€»ç»“

1. **ads.txt ç­‰æ ¹åŸŸåæ–‡ä»¶ä¿ç•™åœ¨ public**
   - æœ€ç®€å•ã€æœ€å¯é 
   - ç¬¦åˆ Google AdSense è¦æ±‚
   - é›¶ç»´æŠ¤æˆæœ¬

2. **å¤§å‹é™æ€èµ„æºï¼ˆå›¾ç‰‡ã€è§†é¢‘ï¼‰ä½¿ç”¨ R2**
   - å‡å°‘æœåŠ¡å™¨å­˜å‚¨å‹åŠ›
   - åˆ©ç”¨ R2 çš„å…è´¹å‡ºå£æµé‡
   - å…¨çƒ CDN åŠ é€Ÿ

3. **ä½¿ç”¨å¢é‡ä¸Šä¼ è„šæœ¬**
   - é¿å…é‡å¤ä¸Šä¼ æœªä¿®æ”¹çš„æ–‡ä»¶
   - èŠ‚çœä¸Šä¼ æ—¶é—´
   - é™ä½ R2 API è°ƒç”¨æ¬¡æ•°

4. **è®¾ç½®åˆç†çš„ç¼“å­˜ç­–ç•¥**
   - å›¾ç‰‡ã€å­—ä½“ï¼š1å¹´ç¼“å­˜
   - CSSã€JSï¼š1å¤©ç¼“å­˜
   - æ–‡æœ¬æ–‡ä»¶ï¼š1å°æ—¶ç¼“å­˜

5. **ç›‘æ§å’Œå‘Šè­¦**
   - å®šæœŸæ£€æŸ¥ ads.txt æ˜¯å¦å¯è®¿é—®
   - ç›‘æ§ R2 ä½¿ç”¨é‡
   - è®¾ç½® Google AdSense å‘Šè­¦

---

## ğŸ¯ æ¨èå†³ç­–æµç¨‹

```
å¼€å§‹
  â†“
æ˜¯å¦æœ‰å¤§é‡é™æ€èµ„æºï¼ˆ> 100MBï¼‰ï¼Ÿ
  â”œâ”€ å¦ â†’ ä½¿ç”¨æ–¹æ¡ˆ 1ï¼ˆæ··åˆæ–¹æ¡ˆï¼‰âœ…
  â””â”€ æ˜¯ â†’ ç»§ç»­
           â†“
       æ˜¯å¦éœ€è¦å…¨çƒåŒ–éƒ¨ç½²ï¼Ÿ
         â”œâ”€ å¦ â†’ ä½¿ç”¨æ–¹æ¡ˆ 2ï¼ˆRewrites ä»£ç†ï¼‰
         â””â”€ æ˜¯ â†’ ç»§ç»­
                  â†“
              æ˜¯å¦æœ‰ä¸“ä¸šè¿ç»´å›¢é˜Ÿï¼Ÿ
                â”œâ”€ å¦ â†’ ä½¿ç”¨æ–¹æ¡ˆ 2ï¼ˆRewrites ä»£ç†ï¼‰
                â””â”€ æ˜¯ â†’ ä½¿ç”¨æ–¹æ¡ˆ 3ï¼ˆWorker è¾¹ç¼˜ï¼‰
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´è¿ç§»æŒ‡å—](./PUBLIC-TO-R2-MIGRATION.md) - è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£
- [R2 é…ç½®æŒ‡å—](./R2-CDN-SETUP.md) - R2 åˆå§‹é…ç½®
- [Next.js Rewrites æ–‡æ¡£](https://nextjs.org/docs/api-reference/next.config.js/rewrites)
- [Cloudflare R2 æ–‡æ¡£](https://developers.cloudflare.com/r2/)

---

**æœ€åæ›´æ–°**: 2025-11-14
**æ¨èæ–¹æ¡ˆ**: æ–¹æ¡ˆ 1ï¼ˆæ··åˆæ–¹æ¡ˆï¼‰- ads.txt ç­‰æ–‡ä»¶ä¿ç•™åœ¨ public
